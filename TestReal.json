{
  "name": "TestReal",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        -2656,
        -320
      ],
      "id": "634b28c3-db76-4aa3-ae8d-b76ac6c979dd",
      "name": "When chat message received",
      "webhookId": "9d2612f3-b699-4bee-bda6-52b98551f2cf"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "127e3f0a-4469-48c8-996c-ab7c16ec18ce",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2656,
        -80
      ],
      "id": "27b8c8af-619d-435a-9899-635e7e218186",
      "name": "Webhook API Trigger",
      "webhookId": "127e3f0a-4469-48c8-996c-ab7c16ec18ce"
    },
    {
      "parameters": {
        "jsCode": "// Extract email_content and user_id from webhook body\nconst emailContent = $input.first().json.body?.email_content || $input.first().json.email_content || '';\nconst userId = $input.first().json.body?.user_id || $input.first().json.user_id || 'default-user';\n\nreturn [{\n  json: {\n    chatInput: emailContent,\n    sessionId: userId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2416,
        -80
      ],
      "id": "2612f8e2-2790-4e61-b5b8-6e6d846ce2e0",
      "name": "Extract Webhook Data"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        544,
        -320
      ],
      "id": "adc4f874-51b0-4d6b-b3b4-fb93d06480d8",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Merge data from chat trigger (direct) or webhook (via Extract Webhook Data)\nconst chatInput = $input.first().json.chatInput;\nlet sessionId = $input.first().json.sessionId;\n\n// ============================================\n// ðŸ”§ TESTING: Change the line below to test different session IDs\n// ============================================\n// OPTION 1: To test with specific ID, UNCOMMENT and change the value:\n   sessionId = \"655\";  // Change this to \"43\", \"655\", \"1234\", etc.\n\n// OPTION 2: To use actual input sessionId, keep the line above COMMENTED\n// ============================================\n\n// Ensure sessionId is an integer\nif (!sessionId || sessionId === 'chat-session-' + Date.now()) {\n  sessionId = 1;\n} else if (typeof sessionId === 'string') {\n  const parsed = parseInt(sessionId);\n  sessionId = isNaN(parsed) ? 1 : parsed;\n} else if (typeof sessionId !== 'number') {\n  sessionId = 1;\n}\n\n// CRITICAL: Generate unique request ID and cart reference for EACH request\n// This ensures both hotels and activities go into the SAME cart\nconst timestamp = Date.now();\nconst randomSuffix = Math.random().toString(36).substring(2, 9).toUpperCase();\nconst requestId = `REQ_${timestamp}_${randomSuffix}`;\nconst cartReference = `CART_${timestamp}_${randomSuffix}`;\n\nreturn [{\n  json: {\n    chatInput: chatInput,\n    sessionId: sessionId,\n    request_id: requestId,\n    cart_reference: cartReference,  // SAME cart reference for both branches\n    request_timestamp: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2400,
        -320
      ],
      "id": "2a294f5a-a18f-4c60-a8a5-0f43878a2ff7",
      "name": "Merge Input Sources"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Travel Content Processor Prompt\n\nâš ï¸ CRITICAL: Treat EACH request as INDEPENDENT. IGNORE any previous conversation history. Process ONLY the current customer input below.\n\nYou are a travel content processor. Your job is to take customer travel requests and convert them into a complete, detailed travel inquiry ready for processing. NEVER ask questions or request more information â€” always make reasonable assumptions.\n\nYour Task\n\nTranslate any non-English content to English.\n\nExtract all provided information (destination, dates, travelers, preferences).\n\nFill in missing details using these DEFAULT assumptions:\n\nTravel Dates:\nIf the travel start date is not provided, assume the travel begins from 15 days after request_timestamp and today is 2025-11-10\nand determine the duration automatically based on the type of destination.\n\n\nCity tours â†’ 4â€“5 days\n\nCountry tours â†’ 7â€“10 days\n\nMulti-country tours â†’ 10â€“14 days\n\nNumber of Travelers: If not specified, assume 1 adult.\n\nBudget: If not mentioned, assume mid-range/standard budget.\n\nAccommodation: If not mentioned, assume 4-star hotels.\n\nMeal Plan: If not mentioned, assume Bed & Breakfast (BB).\n\nActivities: Assume popular tourist attractions and experiences for the destination.\n\nâš ï¸ CRITICAL Duration & Night Calculation Logic (MUST FOLLOW EXACTLY):\n\nðŸ”´ SIMPLE RULE - MEMORIZE THIS:\n\nWhen customer says \"X days\":\n\nDays Mentioned â†’ Nights to Use â†’ Cities to Use\n1 day        â†’ 1 night      â†’ 1 city\n2 days       â†’ 1 night      â†’ 1 city  \n3 days       â†’ 2 nights     â†’ 2 cities\n4 days       â†’ 3 nights     â†’ normal logic\n5 days       â†’ 4 nights     â†’ normal logic\n\nDO NOT calculate anything - just use the table above!\n\nExamples:\n- Customer says \"2 days\" â†’ You MUST write \"2 days, 1 night\" (NOT 2 nights)\n- Customer says \"3 days\" â†’ You MUST write \"3 days, 2 nights\" (NOT 3 nights)\n- Customer says \"5 days\" â†’ You write \"5 days, 4 nights\" (days - 1)\n\nOutput Format\n\nProvide only a clear, professional travel description in paragraph form.\nInclude:\n\nDestination(s)\n\nTravel dates (specific start and end dates)\n\nTotal days and nights (FOLLOW THE TABLE ABOVE EXACTLY)\n\nNumber of travelers\n\nAccommodation and meal plan\n\nBudget level\n\nKey activities or interests\n\nExample Output\n\n\"Customer requesting a Singapore city tour for 2 adults from November 15â€“19, 2025 (5 days, 4 nights). Mid-range budget with 4-star hotel accommodation and bed & breakfast meal plan. Interested in major attractions including Marina Bay Sands, Gardens by the Bay, Sentosa Island, and cultural spots such as Little India and Chinatown.\"\n\nCustomer Input:\n{{ $json.chatInput }}\n\nâš ï¸ REMEMBER: Process ONLY this current input. Ignore previous conversations. FOLLOW the days-to-nights table EXACTLY.\n\nProvide ONLY the refined travel description with all assumptions filled in. Do NOT ask questions.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -2112,
        -320
      ],
      "id": "c5722b28-1f88-419f-9ab2-46ecf96560ec",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2112,
        -16
      ],
      "id": "030f54f5-1214-47f3-97a2-0b91f6ca8ca1",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "CYHGS3KAjICCaQqY",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -2016,
        -16
      ],
      "id": "924557aa-1555-4d8f-9cf1-2a17146c7fb1",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "jsCode": "// Format AI Agent output for OpenAI Travel Parser\nconst aiAgentOutput = $input.first().json.output || $input.first().json.text || '';\nconst cleanedOutput = String(aiAgentOutput).trim();\n\nreturn [{\n  json: {\n    output: cleanedOutput,\n    emailContent: cleanedOutput\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1776,
        -320
      ],
      "id": "ab9223b3-acb7-46d5-bca8-f6cc29da95b7",
      "name": "Format for OpenAI Parser"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"You are an expert travel planner specializing in route optimization and hotel placement. Parse travel requests and provide comprehensive travel planning data in JSON format only.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"You are an expert travel planner. Parse the following travel request and provide comprehensive travel planning data with optimized routing.\\n\\nâš  CRITICAL - FIRST RULE - READ THIS BEFORE PROCESSING âš \\n\\nIF the request contains \\\"1 day\\\" or \\\"1 days\\\":\\n  THEN set total_nights = 1\\n  AND set destination array = [only 1 city]\\n  Example: \\\"I want to plan my 1 days sri lanka trip\\\" â†’ total_nights: 1, destination: [\\\"Colombo\\\"]\\n\\nELSE IF the request contains \\\"2 day\\\" or \\\"2 days\\\":\\n  THEN set total_nights = 1\\n  AND set destination array = [only 1 city]\\n  Example: \\\"I want to plan my 2 days sri lanka trip\\\" â†’ total_nights: 1, destination: [\\\"Colombo\\\"]\\n\\nELSE IF the request contains \\\"3 day\\\" or \\\"3 days\\\":\\n  THEN set total_nights = 2\\n  AND set destination array = [exactly 2 cities]\\n  Example: \\\"I want to plan my 3 days sri lanka trip\\\" â†’ total_nights: 2, destination: [\\\"Colombo\\\", \\\"Kandy\\\"]\\n  âŒ DO NOT use 3 cities\\n  âŒ DO NOT calculate 3-1=2\\n  âœ… HARDCODE: total_nights = 2, cities = 2\\n\\nELSE (4 or more days):\\n  THEN calculate total_nights = days - 1\\n  AND DEFAULT to 3 cities if city count not specified\\n  Example: \\\"7 days trip\\\" â†’ total_nights: 6, destination: [3 cities by default] â†’ 6/3 = 2 nights per city\\n  Example: \\\"10 days trip\\\" â†’ total_nights: 9, destination: [3 cities by default] â†’ 9/3 = 3 nights per city\\n\\nCRITICAL REQUIREMENTS:\\n1. Use current year (2025) for all dates if no year is specified\\n2. TRAVEL START DATE RULES (MANDATORY - HIGHEST PRIORITY):\\n   - If travel start date IS mentioned in request â†’ Use that exact date\\n   - If travel start date is NOT mentioned â†’ Default to 15 days from TODAY (2025-11-25)\\n   - Today's date: 2025-11-10\\n   - Default start date: 2025-11-25 (today + 15 days)\\n3. DURATION EXTRACTION - MANDATORY SPECIAL CASES (OVERRIDE ALL OTHER LOGIC):\\n   - Extract days if mentioned (e.g., 1 day, 2 days, 3 days, 8 days, 10 days)\\n   - âš ï¸ SPECIAL CASE - 1 DAY (MANDATORY OVERRIDE):\\n     * Input: 1 day, 1 days, one day\\n     * Output: ALWAYS 1 night, ALWAYS 1 city\\n     * Ignore any city count requests\\n     * Example: I want to plan my 1 days sri lanka trip â†’ 1 night, 1 city (NOT 0 nights, NOT 3 cities)\\n   - âš ï¸ SPECIAL CASE - 2 DAYS (MANDATORY OVERRIDE):\\n     * Input: 2 day, 2 days, two days\\n     * Output: ALWAYS 1 night, ALWAYS 1 city\\n     * Ignore any city count requests\\n     * Example: I want to plan my 2 days sri lanka trip â†’ 1 night, 1 city (NOT 2 cities)\\n   - âš ï¸ SPECIAL CASE - 3 DAYS (MANDATORY OVERRIDE):\\n     * Input: 3 day, 3 days, three days\\n     * Output: ALWAYS 2 nights, ALWAYS 2 cities\\n     * Ignore default 3 cities, ignore any city count requests\\n     * Example: I want to plan my 3 days sri lanka trip â†’ 2 nights, 2 cities (NOT 7 nights, NOT 3 cities)\\n   - NORMAL CASE - 4+ DAYS ONLY:\\n     * Calculate nights = days - 1 (e.g., 4 days = 3 nights, 8 days = 7 nights, 10 days = 9 nights)\\n     * Apply normal city selection logic\\n   - DEFAULT: 9 NIGHTS (10 days) if not mentioned\\n3. CITY AND DAY COUNT EXTRACTION - CRITICAL:\\n   - STEP 1: Extract DAYS if mentioned (1 day, 2 days, 3 days, 5 days, etc.)\\n   - STEP 2: Extract CITY COUNT if mentioned (e.g., 5 cities, 4 cities, visit 3 cities)\\n   - STEP 3: DAY-BASED CITY LIMITING (CRITICAL):\\n     * âš ï¸ MANDATORY SPECIAL CASES (HIGHEST PRIORITY - OVERRIDE EVERYTHING):\\n       - If 1 day mentioned â†’ FORCE 1 city, 1 night (ignore ALL other logic)\\n       - If 2 days mentioned â†’ FORCE 1 city, 1 night (ignore ALL other logic)\\n       - If 3 days mentioned â†’ FORCE 2 cities, 2 nights (ignore default 3, ignore ALL requests)\\n     * NORMAL CASE (4+ days ONLY):\\n       - If city count specified: use requested cities\\n       - If city count NOT specified: DEFAULT to 3 cities\\n       - Calculate nights per city: total_nights / city_count\\n       - max_cities = minimum of (requested_cities OR default_3, days_count)\\n     * Critical Examples:\\n       - Input: 1 day trip â†’ Output: 1 city, 1 night (MANDATORY)\\n       - Input: 2 days trip â†’ Output: 1 city, 1 night (MANDATORY)\\n       - Input: 3 days trip â†’ Output: 2 cities, 2 nights (MANDATORY, NOT 3 cities)\\n       - Input: 4 days trip â†’ Output: 3 nights, 3 cities default (normal logic)\\n       - Input: 5 days in 3 cities â†’ Output: 4 nights, 3 cities (as specified)\\n       - Input: 7 days trip â†’ Output: 6 nights, 3 cities default â†’ 6/3 = 2 nights per city\\n       - Input: 9 days with 4 cities â†’ Output: 8 nights, 4 cities â†’ 8/4 = 2 nights per city\\n       - Input: 10 days trip â†’ Output: 9 nights, 3 cities default â†’ 9/3 = 3 nights per city\\n   - Extract patterns: X day, X days, in X cities, visit X cities, X cities to visit\\n   - Single-city countries (Singapore, Monaco, Dubai): Always 1 city regardless\\n4. Calculate most efficient travel route between cities\\n5. CRITICAL FORMULA: Divide total nights by number of cities - Formula: nights_per_city = total_nights / city_count\\n6. First city gets base nights, Second city gets base nights, Third city gets base nights + remainder\\n7. DO NOT include activities - only provide hotel/accommodation information\\n8. Include GPS coordinates and check-in/check-out day numbers\\n\\nJSON FORMAT (respond with ONLY this JSON, no additional text):\\n\\nâš ï¸ BEFORE FILLING THIS JSON - CHECK DAY COUNT:\\n- Is it 1, 2, or 3 days? â†’ Use FORCED values from table above\\n- Is it 4+ days? â†’ Use normal calculation\\n\\n{\\n  \\\"destination\\\": [],\\n  \\\"optimized_route\\\": [],\\n  \\\"city_stays\\\": [],\\n  \\\"duration\\\": \\\"\\\",\\n  \\\"total_nights\\\": 0,\\n  \\\"travel_dates\\\": {\\\"start\\\": \\\"\\\", \\\"end\\\": \\\"\\\"},\\n  \\\"pax\\\": {\\n    \\\"adults\\\": 0,\\n    \\\"children\\\": 0,\\n    \\\"child_ages\\\": []\\n  },\\n  \\\"meal_plan\\\": \\\"\\\",\\n  \\\"hotel_category\\\": \\\"\\\",\\n  \\\"additional_requests\\\": \\\"\\\"\\n}\\n\\nEMAIL CONTENT TO PARSE:\\n\" + $json.output + \"\\n\\nRemember:\\n- Current date: \" + new Date().toISOString().slice(0,10) + \"\\n- Default: 9 NIGHTS (10 days) if not specified\\n- Default start date: TODAY + 15 DAYS (\" + new Date(Date.now() + 15*24*60*60*1000).toISOString().slice(0,10) + \")\\n- Respond with ONLY valid JSON, no markdown\"\n    }\n  ],\n  \"temperature\": 0.7\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1584,
        -320
      ],
      "id": "d772f314-ebcd-4f4e-ac59-9b74d55fee5d",
      "name": "OpenAI Travel Parser",
      "credentials": {
        "openAiApi": {
          "id": "CYHGS3KAjICCaQqY",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse OpenAI JSON response\nconst openAIResponse = $input.first().json.choices[0].message.content;\nconst inputData = $('Format for OpenAI Parser').first().json;\n\nlet travelData;\ntry {\n  let jsonString = openAIResponse.trim();\n  if (jsonString.startsWith('```json')) {\n    jsonString = jsonString.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n  } else if (jsonString.startsWith('```')) {\n    jsonString = jsonString.replace(/```\\n?/g, '');\n  }\n  travelData = JSON.parse(jsonString);\n} catch (error) {\n  return [{\n    json: {\n      success: false,\n      message: \"Failed to parse OpenAI response\",\n      error: error.message,\n      raw_response: openAIResponse\n    }\n  }];\n}\n\n// Remove country name from destination array\nif (travelData.destination && Array.isArray(travelData.destination)) {\n  const countries = [\n    'Sri Lanka', 'Thailand', 'Singapore', 'Malaysia', 'Indonesia', 'Vietnam',\n    'Philippines', 'Myanmar', 'Cambodia', 'Laos', 'India', 'China', 'Japan',\n    'South Korea', 'UAE', 'United Arab Emirates', 'Maldives', 'Nepal', 'Bhutan'\n  ];\n  travelData.destination = travelData.destination.filter(dest => {\n    return !countries.some(country => \n      dest.toLowerCase().trim() === country.toLowerCase().trim()\n    );\n  });\n}\n\nconst formattedResponse = {\n  success: true,\n  message: \"Travel itinerary parsed successfully\",\n  travel_data: travelData,\n  suggestions: [\n    `Optimized route: ${travelData.optimized_route?.join(' â†’ ') || 'Route calculated'}`,\n    `${travelData.city_stays?.length || 0} cities with ${travelData.duration || 'planned'} duration`\n  ],\n  metadata: {\n    parsed_at: new Date().toISOString(),\n    destinations_count: travelData.destination?.length || 0\n  }\n};\n\nreturn [{\n  json: formattedResponse\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        -320
      ],
      "id": "2b51cff4-e45d-437c-9ceb-ed36ad23ade8",
      "name": "Parse Travel Data"
    },
    {
      "parameters": {
        "jsCode": "// Add cart reference and generate SINGLE cart_title for BOTH branches\nconst travelData = $input.first().json;\nconst mergeInputData = $('Merge Input Sources').first().json;\n\nlet userId = mergeInputData.sessionId;\nif (typeof userId === 'string') {\n  const numMatch = userId.match(/\\d+/);\n  userId = numMatch ? parseInt(numMatch[0]) : 1;\n} else if (typeof userId !== 'number') {\n  userId = 1;\n}\n\n// CRITICAL: Generate SINGLE cart_title for BOTH hotels and activities\nconst destination = travelData.travel_data?.destination?.[0] || 'Unknown';\nconst duration = travelData.travel_data?.duration || '';\nconst startDate = travelData.travel_data?.travel_dates?.start || '';\n\n// Generate RANDOM SUITABLE CART NAME - SAME for both hotels and activities\nconst cartNamePrefixes = [\n  'Adventure', 'Explorer', 'Wanderer', 'Voyager', 'Journey', 'Traveler',\n  'Discovery', 'Expedition', 'Paradise', 'Escape', 'Gateway', 'Odyssey',\n  'Quest', 'Retreat', 'Safari', 'Tour', 'Venture', 'Holiday', 'Getaway'\n];\n\nconst cartNameSuffixes = [\n  'Dream', 'Experience', 'Journey', 'Adventure', 'Escape', 'Paradise',\n  'Discovery', 'Quest', 'Expedition', 'Voyage', 'Trip', 'Tour', 'Plan',\n  'Package', 'Itinerary', 'Holiday', 'Getaway', 'Memories', 'Bliss'\n];\n\nconst randomPrefix = cartNamePrefixes[Math.floor(Math.random() * cartNamePrefixes.length)];\nconst randomSuffix = cartNameSuffixes[Math.floor(Math.random() * cartNameSuffixes.length)];\nconst randomNumber = Math.floor(Math.random() * 999) + 1;\n\n// Create SINGLE cart name and title for BOTH branches\nconst cartName = `${randomPrefix} ${destination} ${randomSuffix} #${randomNumber}`;\nconst cartTitle = `${cartName} - ${duration} (${startDate})`;\n\nconst dataWithMetadata = {\n  ...travelData,\n  user_id: userId,\n  cart_reference: mergeInputData.cart_reference,  // SAME cart for both branches\n  request_id: mergeInputData.request_id,\n  request_timestamp: mergeInputData.request_timestamp,\n  cart_name: cartName,  // SAME cart name for both branches\n  cart_title: cartTitle  // SAME cart title for both branches - CRITICAL!\n};\n\nreturn [{\n  json: dataWithMetadata\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1184,
        -320
      ],
      "id": "2a8a70c8-be01-4804-97a3-39daf39b44f3",
      "name": "Add Cart Metadata"
    },
    {
      "parameters": {
        "jsCode": "// Process travel data: set hotel star and create destination array for ALL 3 cities\nconst httpRequest1Data = $input.first().json;\n\n// Create a deep copy to avoid mutation\nlet processedData = JSON.parse(JSON.stringify(httpRequest1Data));\n\n// Extract hotel star rating from hotel_category\nif (processedData.travel_data && processedData.travel_data.hotel_category) {\n  const hotelCategory = processedData.travel_data.hotel_category;\n  \n  // Extract number from strings like \"3-Star\", \"4-Star\", \"5-Star\"\n  const starMatch = hotelCategory.match(/(\\d+)/);\n  \n  if (starMatch) {\n    processedData.travel_data.hotel_star = parseInt(starMatch[1]);\n  } else {\n    // Default to 4 star if no number found\n    processedData.travel_data.hotel_star = 4;\n  }\n} else {\n  // Default to 4 star if hotel_category is not mentioned\n  if (!processedData.travel_data) {\n    processedData.travel_data = {};\n  }\n  processedData.travel_data.hotel_star = 4;\n}\n\n// CRITICAL: Build destination array from city_stays for ALL 3 cities\n// Each city needs hotel booking - if staying multiple nights, it's ONE hotel for all nights\nif (processedData.travel_data && processedData.travel_data.city_stays && Array.isArray(processedData.travel_data.city_stays)) {\n  const cityStays = processedData.travel_data.city_stays;\n  \n  // Build destination array with ALL cities from optimized route\n  // Each city appears ONCE even if staying multiple nights (same hotel for all nights)\n  const destinations = cityStays.map(cityStay => cityStay.city);\n  \n  // Update destination array with all 3 cities\n  processedData.travel_data.destination = destinations;\n  \n  // Create detailed city information including nights per city\n  processedData.travel_data.city_details = cityStays.map(cityStay => ({\n    city: cityStay.city,\n    nights: cityStay.nights,\n    order: cityStay.order,\n    check_in_day: cityStay.check_in_day,\n    check_out_day: cityStay.check_out_day,\n    coordinates: cityStay.coordinates,\n    accommodation_type: cityStay.accommodation_type,\n    hotel_booking_note: cityStay.nights > 1 \n      ? `Book ONE hotel for ${cityStay.nights} nights in ${cityStay.city}` \n      : `Book ONE hotel for ${cityStay.nights} night in ${cityStay.city}`\n  }));\n  \n  // Store important metadata\n  processedData.travel_data.total_cities = cityStays.length;\n  processedData.travel_data.total_nights = cityStays.reduce((sum, city) => sum + city.nights, 0);\n  processedData.travel_data.hotel_booking_summary = {\n    total_cities: cityStays.length,\n    total_hotels_needed: cityStays.length, // One hotel per city\n    booking_details: cityStays.map(city => `${city.city}: ${city.nights} night(s) in ONE hotel`)\n  };\n}\n\nreturn [{\n  json: processedData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        -480
      ],
      "id": "5ef33238-5e80-4789-ba32-dc57744bcb2d",
      "name": "Process Cities & Hotel Rating"
    },
    {
      "parameters": {
        "jsCode": "// Process travel data: extract activity preferences and create city-wise activity data\nconst httpRequest1Data = $input.first().json;\n\n// Create a deep copy to avoid mutation\nlet processedData = JSON.parse(JSON.stringify(httpRequest1Data));\n\n// Extract activity preferences (replaces hotel star rating)\nif (processedData.travel_data) {\n  // Set activity preferences from budget level or use default\n  processedData.travel_data.activity_preferences = processedData.travel_data.activity_preferences || 'popular_attractions';\n  processedData.travel_data.budget_level = processedData.travel_data.budget_level || 'mid-range';\n}\n\n// CRITICAL: Build destination array and activity focus for each city\nif (processedData.travel_data && processedData.travel_data.city_stays && Array.isArray(processedData.travel_data.city_stays)) {\n  const cityStays = processedData.travel_data.city_stays;\n  \n  // Build destination array with ALL cities\n  const destinations = cityStays.map(cityStay => cityStay.city);\n  processedData.travel_data.destination = destinations;\n  \n  // Create detailed city information for activities\n  // CRITICAL: days_in_city = nights (NOT nights + 1) because checkout day has no activities\n  processedData.travel_data.city_details = cityStays.map(cityStay => ({\n    city: cityStay.city,\n    nights: cityStay.nights,\n    order: cityStay.order,\n    check_in_day: cityStay.check_in_day,\n    check_out_day: cityStay.check_out_day,\n    coordinates: cityStay.coordinates,\n    activity_focus: 'top_attractions',\n    days_in_city: cityStay.nights  // Activities only on nights, not checkout day\n  }));\n  \n  // Store important metadata\n  processedData.travel_data.total_cities = cityStays.length;\n  processedData.travel_data.total_nights = cityStays.reduce((sum, city) => sum + city.nights, 0);\n  processedData.travel_data.activity_summary = {\n    total_cities: cityStays.length,\n    total_activity_days: cityStays.reduce((sum, city) => sum + city.nights, 0),  // Activity days = nights (not checkout day)\n    activity_details: cityStays.map(city => `${city.city}: ${city.nights} days of activities (2 per day)`)\n  };\n}\n\nreturn [{\n  json: processedData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        -160
      ],
      "id": "3ae9b15c-7f3f-4959-b53b-c26578ad7b2e",
      "name": "Process Cities & Activities"
    },
    {
      "parameters": {
        "jsCode": "// Sanitize data for Hotels API\nconst inputData = $input.first().json;\nfunction cleanString(str) {\n  if (typeof str !== 'string') return str;\n  return str.replace(/[\\x00-\\x08\\x0B-\\x0C\\x0E-\\x1F\\x7F]/g, '');\n}\nfunction cleanObject(obj) {\n  if (obj === null || obj === undefined) return obj;\n  if (typeof obj === 'string') return cleanString(obj);\n  if (Array.isArray(obj)) return obj.map(item => cleanObject(item));\n  if (typeof obj === 'object') {\n    const cleaned = {};\n    for (const key in obj) {\n      if (obj.hasOwnProperty(key)) cleaned[key] = cleanObject(obj[key]);\n    }\n    return cleaned;\n  }\n  return obj;\n}\nreturn [{ json: cleanObject(inputData) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -848,
        -656
      ],
      "id": "41ad52a6-809d-49a2-ac43-5216876500c2",
      "name": "Sanitize Hotels Data"
    },
    {
      "parameters": {
        "jsCode": "// Sanitize data for Activities API\nconst inputData = $input.first().json;\nfunction cleanString(str) {\n  if (typeof str !== 'string') return str;\n  return str.replace(/[\\x00-\\x08\\x0B-\\x0C\\x0E-\\x1F\\x7F]/g, '');\n}\nfunction cleanObject(obj) {\n  if (obj === null || obj === undefined) return obj;\n  if (typeof obj === 'string') return cleanString(obj);\n  if (Array.isArray(obj)) return obj.map(item => cleanObject(item));\n  if (typeof obj === 'object') {\n    const cleaned = {};\n    for (const key in obj) {\n      if (obj.hasOwnProperty(key)) cleaned[key] = cleanObject(obj[key]);\n    }\n    return cleaned;\n  }\n  return obj;\n}\nreturn [{ json: cleanObject(inputData) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        0
      ],
      "id": "45635953-1355-4ed4-9daa-a8b749bb7a36",
      "name": "Sanitize Activities Data"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://192.16.26.182:8000/api/automate/products/list",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        160
      ],
      "id": "a21561c0-1d80-46cc-9a5c-b8b96d80aa06",
      "name": "Read Activities Excel List"
    },
    {
      "parameters": {
        "jsCode": "// Match activities from database API based on city\nconst flowData = $('Sanitize Activities Data').first().json;\nconst apiResponse = $('Read Activities Excel List').all();\n\n// Parse API response - handle different response formats\nlet productsData = [];\n\nfor (const item of apiResponse) {\n  // Check if response has a 'data' or 'products' array\n  if (item.json.data && Array.isArray(item.json.data)) {\n    productsData = item.json.data;\n  } else if (item.json.products && Array.isArray(item.json.products)) {\n    productsData = item.json.products;\n  } else if (Array.isArray(item.json)) {\n    productsData = item.json;\n  } else {\n    // Single item response\n    productsData.push(item.json);\n  }\n}\n\n// Extract activities from products\n// Expected fields: country, city, title/name/activity, product_id\nconst databaseActivities = [];\nfor (const product of productsData) {\n  if (product.country && product.city) {\n    databaseActivities.push({\n      country: String(product.country).trim(),\n      city: String(product.city).trim(),\n      activity: String(product.title || product.name || product.activity || product.product_name || '').trim(),\n      product_id: product.product_id || product.id || null,\n      sub_category_id: product.sub_category_id || product.category_id || null\n    });\n  }\n}\n\n// Get cities from the itinerary\nconst cities = flowData.travel_data?.city_details || [];\n\n// Match database activities to each city\nconst cityActivitiesMap = {};\nconst cityProductsMap = {};\n\ncities.forEach(cityDetail => {\n  const cityName = cityDetail.city;\n  \n  // Find matching activities from database for this city\n  const matchedProducts = databaseActivities.filter(dbItem => \n    dbItem.city.toLowerCase() === cityName.toLowerCase()\n  );\n  \n  // Store activity names for AI prompt\n  cityActivitiesMap[cityName] = matchedProducts.map(item => item.activity).filter(a => a);\n  \n  // Store full product details for reference\n  cityProductsMap[cityName] = matchedProducts;\n});\n\n// Add matched activities to flow data\nconst enrichedData = {\n  ...flowData,\n  excel_activities_map: cityActivitiesMap,  // Keep same name for compatibility\n  database_products_map: cityProductsMap,    // Full product details\n  excel_activities_count: Object.values(cityActivitiesMap).reduce((sum, arr) => sum + arr.length, 0),\n  data_source: 'database_api'  // Indicate data comes from database\n};\n\nreturn [{ json: enrichedData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -560,
        160
      ],
      "id": "bfca71c8-342a-44c2-b722-f4705f5d2b85",
      "name": "Match City Activities from Excel"
    },
    {
      "parameters": {
        "jsCode": "// Merge Excel activities with AI-generated activities\n// Priority: Excel activities FIRST, then AI activities to fill remaining slots\nconst inputData = $input.first().json;\n\n// Get Excel activities map\nconst excelActivitiesMap = inputData.excel_activities_map || {};\nconst hasExcelActivities = inputData.excel_activities_count > 0;\n\n// Prepare merged activities instruction for OpenAI prompt\nconst cityActivitiesInstructions = [];\n\nif (inputData.travel_data && inputData.travel_data.city_details) {\n  inputData.travel_data.city_details.forEach(cityDetail => {\n    const cityName = cityDetail.city;\n    const excelActivities = excelActivitiesMap[cityName] || [];\n    \n    if (excelActivities.length > 0) {\n      cityActivitiesInstructions.push({\n        city: cityName,\n        excel_activities: excelActivities,\n        instruction: `For ${cityName}: PRIORITIZE these activities from the curated list: ${excelActivities.join(', ')}. Use these FIRST before generating other activities.`\n      });\n    }\n  });\n}\n\n// Add merged instructions to flow data\nconst mergedData = {\n  ...inputData,\n  city_activities_priority: cityActivitiesInstructions,\n  use_excel_priority: hasExcelActivities\n};\n\nreturn [{ json: mergedData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        160
      ],
      "id": "b4158813-13ec-442a-b657-0240e2164559",
      "name": "Merge Excel & AI Activities"
    },
    {
      "parameters": {
        "jsCode": "// Build OpenAI prompt for HOTELS-ONLY itinerary generation\nconst inputData = $input.first().json;\nconst data = inputData.travel_data;\n\nconst destination = data.destination?.[0] || 'Unknown';\nconst startDate = data.travel_dates?.start || '';\nconst endDate = data.travel_dates?.end || '';\nconst duration = data.duration || '';\nconst adults = data.pax?.adults || 1;\nconst children = data.pax?.children || 0;\nconst childAges = data.pax?.child_ages || [];\nconst mealPlan = data.meal_plan || 'BB';\nconst hotelCategory = data.hotel_category || '4-Star';\nconst starCategory = data.hotel_star || 4;\n\n// Get cities from city_details\nconst cities = data.city_details || [];\nconst citiesStr = cities.map(c => `${c.city} (${c.nights} nights, Days ${c.check_in_day}-${c.check_out_day})`).join(', ');\n\n// Calculate total days\nconst start = new Date(startDate);\nconst end = new Date(endDate);\nconst totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;\n\n// Build city stays breakdown text\nconst cityStaysBreakdown = cities.map(c => `- ${c.city}: ${c.nights} nights (Check-in Day ${c.check_in_day}, Check-out Day ${c.check_out_day}) at ${c.coordinates}`).join('\\n');\n\n// Build city planning section\nlet cityPlanningText = '- Respect the city stays schedule\\n';\nif (cities[0]) {\n  cityPlanningText += `   - Day ${cities[0].check_in_day}-${cities[0].check_out_day}: Stay in ${cities[0].city}\\n`;\n}\nif (cities[1]) {\n  cityPlanningText += `   - Day ${cities[1].check_in_day}-${cities[1].check_out_day}: Stay in ${cities[1].city}\\n`;\n}\nif (cities[2]) {\n  cityPlanningText += `   - Day ${cities[2].check_in_day}-${cities[2].check_out_day}: Stay in ${cities[2].city}\\n`;\n}\n\n// Build example itinerary text\nconst exampleItinerary = cities.map(city => {\n  const startDay = city.check_in_day;\n  const endDay = city.check_out_day;\n  const nights = city.nights;\n  return `Days ${startDay}-${endDay - 1} (${city.city} - ${nights} nights):\\n- Accommodation in ${city.city}\\n- Coordinates near ${city.coordinates}`;\n}).join('\\n\\n');\n\nconst lastCity = cities[cities.length - 1]?.city || 'last city';\nconst citiesRoute = cities.map(c => c.city).join(' â†’ ');\n\n// Build the complete prompt\nconst userPrompt = `You are an expert travel planner. Create a detailed day-by-day itinerary for a ${totalDays}-day trip.\\n\\nIMPORTANT: HOTELS/ACCOMMODATION ONLY - DO NOT include activities!\\n\\nTRIP DETAILS:\\n- Cities: ${citiesStr}\\n- Duration: ${duration} (${startDate} to ${endDate})\\n- Total Days: ${totalDays}\\n- Travelers: ${adults} adults, ${children} children\\n- Child Ages: ${JSON.stringify(childAges)}\\n- Meal Plan: ${mealPlan}\\n- Hotel Category: ${hotelCategory} (${starCategory}-Star)\\n\\nCITY STAYS BREAKDOWN:\\n${cityStaysBreakdown}\\n\\nCRITICAL REQUIREMENTS:\\n\\n1. HOTELS ONLY - NO ACTIVITIES:\\n   - DO NOT include activities array\\n   - DO NOT include activity details\\n   - ONLY provide accommodation information per day\\n\\n2. PAX OBJECT (MANDATORY):\\n   - EVERY day MUST include pax object: {\\\"adults\\\": ${adults}, \\\"children\\\": ${children}, \\\"child_ages\\\": ${JSON.stringify(childAges)}}\\n\\n3. ONE HOTEL PER CITY FOR ALL NIGHTS:\\n   - Each city gets ONE hotel booking for ALL nights in that city\\n   - Example: 10 days 9 nights, 3 cities (9Ã·3=3 nights each):\\n     * City 1 (Days 1-3): ONE hotel, check_in Day 1, check_out Day 4\\n       - Day 1: accommodation with check_in=\\\"2025-12-15\\\", check_out=\\\"2025-12-18\\\"\\n       - Day 2: accommodation with SAME check_in=\\\"2025-12-15\\\", check_out=\\\"2025-12-18\\\"\\n       - Day 3: accommodation with SAME check_in=\\\"2025-12-15\\\", check_out=\\\"2025-12-18\\\"\\n     * City 2 (Days 4-6): ONE hotel, check_in Day 4, check_out Day 7\\n       - Day 4: accommodation with check_in=\\\"2025-12-18\\\", check_out=\\\"2025-12-21\\\"\\n       - Day 5: accommodation with SAME check_in=\\\"2025-12-18\\\", check_out=\\\"2025-12-21\\\"\\n       - Day 6: accommodation with SAME check_in=\\\"2025-12-18\\\", check_out=\\\"2025-12-21\\\"\\n     * City 3 (Days 7-9): ONE hotel, check_in Day 7, check_out Day 10\\n       - Day 7: accommodation with check_in=\\\"2025-12-21\\\", check_out=\\\"2025-12-24\\\"\\n       - Day 8: accommodation with SAME check_in=\\\"2025-12-21\\\", check_out=\\\"2025-12-24\\\"\\n       - Day 9: accommodation with SAME check_in=\\\"2025-12-21\\\", check_out=\\\"2025-12-24\\\"\\n   - All days in same city MUST have IDENTICAL accommodation object\\n   - Check-in date = First day of city stay\\n   - Check-out date = Last day of city stay + 1 day\\n\\n4. ACCOMMODATION (MANDATORY FIELDS):\\n   - check_in: date (YYYY-MM-DD) - FIRST day of stay in that city\\n   - check_out: date (YYYY-MM-DD) - LAST day of stay + 1 day in that city\\n   - star_category: ${starCategory} (integer)\\n   - keywords: [\\\"${hotelCategory}\\\", \\\"${mealPlan}\\\", city name, amenities like \\\"pool\\\", \\\"wifi\\\", \\\"breakfast\\\"]\\n   - latitude: number\\n   - longitude: number\\n\\n5. CITY-BASED PLANNING:\\n${cityPlanningText}\\n\\nREQUIRED JSON STRUCTURE (HOTELS ONLY):\\n\\n{\\n  \\\"itinerary\\\": [\\n    {\\n      \\\"day\\\": 1,\\n      \\\"date\\\": \\\"${startDate}\\\",\\n      \\\"city\\\": \\\"${cities[0]?.city || 'City Name'}\\\",\\n      \\\"pax\\\": {\\n        \\\"adults\\\": ${adults},\\n        \\\"children\\\": ${children},\\n        \\\"child_ages\\\": ${JSON.stringify(childAges)}\\n      },\\n      \\\"accommodation\\\": {\\n        \\\"check_in\\\": \\\"${startDate}\\\",\\n        \\\"check_out\\\": \\\"2025-12-16\\\",\\n        \\\"star_category\\\": ${starCategory},\\n        \\\"keywords\\\": [\\\"${hotelCategory}\\\", \\\"${mealPlan}\\\", \\\"city\\\", \\\"pool\\\", \\\"wifi\\\"],\\n        \\\"latitude\\\": 7.2910,\\n        \\\"longitude\\\": 80.6350\\n      }\\n    }\\n  ]\\n}\\n\\nEXAMPLE FOR ${totalDays}-DAY ITINERARY (HOTELS ONLY):\\n\\n${exampleItinerary}\\n\\nDay ${totalDays} (${endDate}): \\n- Departure day from ${lastCity}\\n- NO accommodation (checkout day)\\n- Set accommodation to null\\n\\nCRITICAL REMINDERS:\\nâœ“ DO NOT include activities - HOTELS ONLY\\nâœ“ EVERY day MUST have pax object at day level\\nâœ“ EVERY accommodation MUST have star_category: ${starCategory}\\nâœ“ Accommodation keywords MUST include \\\"${hotelCategory}\\\" and \\\"${mealPlan}\\\"\\nâœ“ ALL days in same city MUST have IDENTICAL accommodation check_in and check_out dates\\nâœ“ Respect city stays schedule (${citiesRoute})\\nâœ“ Last day (Day ${totalDays}) has NO accommodation (set to null)\\nâœ“ Respond with ONLY valid JSON, no markdown\\n\\nGenerate the HOTELS-ONLY itinerary now!`;\n\n// Build the OpenAI API request body\nconst requestBody = {\n  model: \"gpt-4o\",\n  messages: [\n    {\n      role: \"system\",\n      content: \"You are an expert travel planner. Create detailed day-by-day hotel itineraries in JSON format only. DO NOT include activities.\"\n    },\n    {\n      role: \"user\",\n      content: userPrompt\n    }\n  ],\n  temperature: 0.7\n};\n\n// Return data with the request body and original input data\nreturn [{\n  json: {\n    ...inputData,\n    openai_request: requestBody\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -688,
        -480
      ],
      "id": "d3ee74d6-e9fd-4aa1-a605-ed23dc7df4cc",
      "name": "Build Itinerary Prompt"
    },
    {
      "parameters": {
        "jsCode": "// Build OpenAI prompt for ACTIVITIES-ONLY itinerary generation\nconst inputData = $input.first().json;\nconst data = inputData.travel_data;\n\nconst destination = data.destination?.[0] || 'Unknown';\nconst startDate = data.travel_dates?.start || '';\nconst endDate = data.travel_dates?.end || '';\nconst duration = data.duration || '';\nconst adults = data.pax?.adults || 1;\nconst children = data.pax?.children || 0;\nconst childAges = data.pax?.child_ages || [];\nconst activityPreferences = data.activity_preferences || 'popular_attractions';\nconst budgetLevel = data.budget_level || 'mid-range';\n\n// Get cities from city_details\nconst cities = data.city_details || [];\nconst citiesStr = cities.map(c => `${c.city} (${c.days_in_city} days)`).join(', ');\n\n// Calculate total days\nconst start = new Date(startDate);\nconst end = new Date(endDate);\nconst totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;\n\n// Build city stays breakdown\nconst cityStaysBreakdown = cities.map(c => `- ${c.city}: ${c.days_in_city} days with activities (Day ${c.check_in_day} to Day ${c.check_out_day - 1}) - NO activities on checkout day ${c.check_out_day}`).join('\\n');\n\nconst lastCity = cities[cities.length - 1]?.city || 'last city';\nconst citiesRoute = cities.map(c => c.city).join(' â†’ ');\n\n// Build detailed city-specific activity instructions\nconst cityActivityInstructions = cities.map((city, index) => {\n  const cityNum = index + 1;\n  const checkInDay = city.check_in_day;\n  const checkOutDay = city.check_out_day;\n  const stayDays = [];\n  \n  // Generate list of days for this city (excluding checkout day)\n  for (let day = checkInDay; day < checkOutDay; day++) {\n    stayDays.push(day);\n  }\n  \n  return `CITY ${cityNum}: ${city.city}\\n   - Days ${checkInDay} to ${checkOutDay - 1} (${city.nights} nights = ${city.nights} days with activities)\\n   - Day ${checkOutDay} is checkout day - NO ACTIVITIES on this day\\n   - Activities MUST be in ${city.city} area ONLY\\n   - GPS coordinates MUST be within ${city.city} city limits\\n   - MAXIMUM 2 activities per day (strictly enforced - NO exceptions)\\n   - Activities should be LOCAL to ${city.city} - NOT from other cities`;\n}).join('\\n\\n');\n\n// Build the complete prompt for ACTIVITIES with strict city-wise filtering\nconst userPrompt = `You are an expert travel planner. Create a detailed day-by-day ACTIVITIES itinerary for a ${totalDays}-day trip.\n\nâš ï¸ CRITICAL: CITY-WISE ACTIVITY FILTERING - READ THIS FIRST! âš ï¸\n\nEach city in the itinerary has specific check-in and check-out days.\nYou MUST suggest activities ONLY for the city where the traveler is staying on that specific day.\nActivities are ONLY on days when they are staying (check-in day to day before checkout).\n\nExample - 9 days with 4 cities:\n- Days 1-2 in Colombo (checkout Day 3) â†’ Activities on Day 1 & 2 ONLY in Colombo (2 activities each day)\n- Days 3-4 in Kandy (checkout Day 5) â†’ Activities on Day 3 & 4 ONLY in Kandy (2 activities each day)\n- Days 5-6 in Ella (checkout Day 7) â†’ Activities on Day 5 & 6 ONLY in Ella (2 activities each day)\n- Days 7-8 in Galle (checkout Day 9) â†’ Activities on Day 7 & 8 ONLY in Galle (2 activities each day)\n- Day 9 is departure - NO ACTIVITIES\n\nDO NOT mix cities! If they are staying in Colombo, do NOT suggest Kandy or Galle activities.\n\nIMPORTANT: ACTIVITIES ONLY - DO NOT include accommodation/hotels!\n\nTRIP DETAILS:\n- Cities: ${citiesStr}\n- Duration: ${duration} (${startDate} to ${endDate})\n- Total Days: ${totalDays}\n- Travelers: ${adults} adults, ${children} children\n- Child Ages: ${JSON.stringify(childAges)}\n- Activity Preferences: ${activityPreferences}\n- Budget Level: ${budgetLevel}\n\nCITY BREAKDOWN WITH STRICT ACTIVITY ZONES:\n${cityStaysBreakdown}\n\nâš ï¸ MANDATORY CITY-WISE ACTIVITY MAPPING:\n${cityActivityInstructions}\n\nCRITICAL REQUIREMENTS:\n\n1. ACTIVITIES ONLY - NO HOTELS:\n   - DO NOT include accommodation/hotel information\n   - FOCUS on activities, attractions, experiences\n   - Include activities array for each day\n\n2. PAX OBJECT (MANDATORY):\n   - EVERY day MUST include pax object: {\"adults\": ${adults}, \"children\": ${children}, \"child_ages\": ${JSON.stringify(childAges)}}\n\n3. âš ï¸ STRICT CITY-WISE ACTIVITY RULES (MOST IMPORTANT):\n   - MAXIMUM 2 activities per day (STRICTLY ENFORCED - DO NOT suggest 3 or more)\n   - Each day MUST have EXACTLY 2 activities (or 1-2 if very limited options)\n   - DO NOT suggest 3 activities per day under any circumstances\n   - Activities ONLY on days between check-in and (check-out - 1)\n   - NO activities on checkout day (departure day)\n   - Activities MUST match the city where they are staying that day\n   - If Day 1-2 is Colombo, suggest ONLY Colombo activities on Days 1 & 2\n   - If Day 3-4 is Kandy, suggest ONLY Kandy activities on Days 3 & 4\n   - If Day 5-6 is Ella, suggest ONLY Ella activities on Days 5 & 6\n   - GPS coordinates MUST be within the correct city boundaries\n   - DO NOT suggest activities from other cities\n   - Last day (final checkout/departure day): NO activities at all\n\n4. ACTIVITY CATEGORIES with sub_category_id mapping:\n   - Adventure = 1\n   - Entertainment = 2\n   - Health & Wellness = 3\n   - Event = 4\n   - Tours = 5\n   - Transport = 6\n   - Services = 7\n   - Tickets = 8\n   - Culinary = 9\n   - Experience = 10\n   - Vacation Packages = 46\n\n5. ACTIVITY OBJECT (MANDATORY FIELDS):\n   - activity_name: string (name of attraction/activity)\n   - category: string (Adventure/Entertainment/Health & Wellness/Event/Tours/Transport/Services/Tickets/Culinary/Experience/Vacation Packages)\n   - sub_category_id: integer (MANDATORY - use mapping above based on category)\n   - description: string (brief description mentioning the city)\n   - duration: string (e.g., \"2-3 hours\", \"half day\", \"full day\")\n   - latitude: number (GPS coordinate within the correct city)\n   - longitude: number (GPS coordinate within the correct city)\n   - best_time: string (e.g., \"morning\", \"afternoon\", \"evening\", \"anytime\")\n   - cost_level: string (\"free\", \"low\", \"medium\", \"high\")\n\n6. CITY-BASED PLANNING:\n   - Respect the city schedule STRICTLY: ${citiesRoute}\n   - Each day's activities MUST be in the correct city\n   - Verify GPS coordinates match the city\n\nREQUIRED JSON STRUCTURE (ACTIVITIES ONLY):\n\n{\n  \"itinerary\": [\n    {\n      \"day\": 1,\n      \"date\": \"${startDate}\",\n      \"city\": \"${cities[0]?.city || 'City Name'}\",\n      \"pax\": {\n        \"adults\": ${adults},\n        \"children\": ${children},\n        \"child_ages\": ${JSON.stringify(childAges)}\n      },\n      \"activities\": [\n        {\n          \"activity_name\": \"Galle Face Green\",\n          \"category\": \"Tours\",\n          \"sub_category_id\": 5,\n          \"description\": \"Scenic promenade in Colombo city center\",\n          \"duration\": \"2 hours\",\n          \"latitude\": 6.9271,\n          \"longitude\": 79.8612,\n          \"best_time\": \"evening\",\n          \"cost_level\": \"free\"\n        },\n        {\n          \"activity_name\": \"National Museum of Colombo\",\n          \"category\": \"Tours\",\n          \"sub_category_id\": 5,\n          \"description\": \"Sri Lanka's largest museum in Colombo\",\n          \"duration\": \"2-3 hours\",\n          \"latitude\": 6.9074,\n          \"longitude\": 79.8612,\n          \"best_time\": \"morning\",\n          \"cost_level\": \"low\"\n        }\n      ]\n    }\n  ]\n}\n\nâš ï¸ CRITICAL VALIDATION CHECKLIST BEFORE GENERATING:\nâœ“ DO NOT include hotels/accommodation - ACTIVITIES ONLY\nâœ“ EVERY day MUST have pax object\nâœ“ MAXIMUM 2 activities per day (STRICTLY ENFORCED - DO NOT suggest 3 activities)\nâœ“ EVERY activity MUST have latitude and longitude IN THE CORRECT CITY\nâœ“ EVERY activity MUST have sub_category_id (use category mapping)\nâœ“ Category mapping: Adventure=1, Entertainment=2, Health & Wellness=3, Event=4, Tours=5, Transport=6, Services=7, Tickets=8, Culinary=9, Experience=10, Vacation Packages=46\nâœ“ Activities MUST match the city for that day (e.g., Day 1-2 Colombo = Colombo activities ONLY)\nâœ“ GPS coordinates MUST be within city boundaries\nâœ“ Mix different activity categories within same city\nâœ“ Consider child ages when suggesting activities\nâœ“ Respect city schedule STRICTLY (${citiesRoute})\nâœ“ Last day (checkout): NO activities at all - it's departure day\nâœ“ Example: 9 days trip = Days 1-8 have activities, Day 9 NO activities\nâœ“ Each active day (not checkout) has EXACTLY 2 activities in the correct city\nâœ“ Respond with ONLY valid JSON, no markdown\n\nGenerate the CITY-WISE ACTIVITIES-ONLY itinerary now with strict location filtering!`;\n\n// Build the OpenAI API request body\nconst requestBody = {\n  model: \"gpt-4o\",\n  messages: [\n    {\n      role: \"system\",\n      content: \"You are an expert travel planner. Create detailed day-by-day activity itineraries with GPS coordinates and sub_category_id in JSON format only. EVERY activity MUST include sub_category_id based on category mapping: Adventure=1, Entertainment=2, Health & Wellness=3, Event=4, Tours=5, Transport=6, Services=7, Tickets=8, Culinary=9, Experience=10, Vacation Packages=46. DO NOT include hotels/accommodation. CRITICAL: Activities MUST be city-specific - only suggest activities in the city where the traveler is staying that day.\"\n    },\n    {\n      role: \"user\",\n      content: userPrompt\n    }\n  ],\n  temperature: 0.7\n};\n\n// Return data with the request body and original input data\nreturn [{\n  json: {\n    ...inputData,\n    openai_request: requestBody\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        -160
      ],
      "id": "f8eb9644-2322-4e68-a0c0-4b7fe8ffdd58",
      "name": "Build Activities Itinerary Prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.openai_request) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -528,
        -672
      ],
      "id": "ed422223-93da-495d-926c-fad24b28914f",
      "name": "Generate Hotels Itinerary",
      "credentials": {
        "openAiApi": {
          "id": "CYHGS3KAjICCaQqY",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.openai_request) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -528,
        -160
      ],
      "id": "89f4e622-24b9-465d-a008-fd1f2d8b2ae1",
      "name": "Generate Activities Itinerary",
      "credentials": {
        "openAiApi": {
          "id": "CYHGS3KAjICCaQqY",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse OpenAI itinerary response and format for cart processing (HOTELS ONLY)\n// CRITICAL: Group hotels by city - ONE HOTEL PER CITY, not per day\nconst openAIResponse = $input.first().json.choices[0].message.content;\nconst inputData = $('Sanitize Hotels Data').first().json;\n\nlet itineraryData;\ntry {\n  // Remove markdown code blocks if present\n  let jsonString = openAIResponse.trim();\n  if (jsonString.startsWith('```json')) {\n    jsonString = jsonString.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n  } else if (jsonString.startsWith('```')) {\n    jsonString = jsonString.replace(/```\\n?/g, '');\n  }\n  \n  itineraryData = JSON.parse(jsonString);\n} catch (error) {\n  return [{\n    json: {\n      success: false,\n      message: \"Failed to parse OpenAI itinerary response\",\n      error: error.message,\n      raw_response: openAIResponse\n    }\n  }];\n}\n\n// CRITICAL: Group days by city to create ONE hotel booking per city\nconst cityGroups = {};\nconst itineraryWithHotelsOnly = [];\n\nitineraryData.itinerary.forEach(day => {\n  const cityName = day.city;\n  \n  // Group days by city\n  if (!cityGroups[cityName]) {\n    cityGroups[cityName] = {\n      days: [],\n      accommodation: day.accommodation && day.accommodation !== null ? day.accommodation : null,\n      pax: day.pax\n    };\n  }\n  \n  cityGroups[cityName].days.push({\n    day: day.day,\n    date: day.date\n  });\n});\n\n// Build itinerary with ONE accommodation entry per city (not per day)\n// Each city gets ONE hotel for ALL its nights\nitineraryData.itinerary.forEach(day => {\n  const dayData = {\n    day: day.day,\n    date: day.date,\n    city: day.city,\n    pax: day.pax\n  };\n  \n  // Only add accommodation for the FIRST day of each city\n  const cityName = day.city;\n  const cityDays = cityGroups[cityName].days;\n  const isFirstDayInCity = cityDays[0].day === day.day;\n  \n  if (isFirstDayInCity && day.accommodation && day.accommodation !== null) {\n    // This is the first day in this city - add accommodation for the entire stay\n    dayData.accommodation = day.accommodation;\n  } else if (!day.accommodation || day.accommodation === null) {\n    // Last day - no accommodation\n    dayData.accommodation = [];\n  }\n  // Other days in the same city: NO accommodation field (will be handled by Laravel)\n  \n  itineraryWithHotelsOnly.push(dayData);\n});\n\n// Get the unique cart_reference, cart_name, and cart_title generated at the start of the flow\nconst cartReference = inputData.cart_reference;\nconst requestId = inputData.request_id;\nconst cartName = inputData.cart_name;  // Use shared cart name from \"Add Cart Metadata\"\nconst cartTitle = inputData.cart_title;  // Use shared cart title from \"Add Cart Metadata\"\n\n// Use the shared cart title as itinerary title\nconst itineraryTitle = cartTitle;\n\n// Format response to match Laravel API structure\nconst formattedResponse = {\n  success: true,\n  message: \"Day-wise hotel itinerary generated successfully\",\n  itinerary_title: itineraryTitle,\n  cart_name: cartName,  // Human-readable cart name\n  cart_reference: cartReference,  // Use cart reference from beginning of flow\n  request_id: requestId,  // Request tracking ID\n  itinerary: itineraryWithHotelsOnly,\n  travel_data: inputData.travel_data,\n  user_id: inputData.user_id,\n  force_new_cart: true,  // Always create new cart for each request\n  metadata: {\n    total_days: itineraryWithHotelsOnly.length,\n    total_hotels: itineraryWithHotelsOnly.filter(day => day.accommodation && Array.isArray(day.accommodation) && day.accommodation.length === 0 ? false : day.accommodation).length,\n    generated_at: new Date().toISOString(),\n    generation_method: \"OpenAI GPT-4o\",\n    note: \"Hotels only - no activities included\",\n    cart_reference: cartReference,\n    cart_name: cartName,\n    request_id: requestId\n  }\n};\n\nreturn [{\n  json: formattedResponse\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        -480
      ],
      "id": "b0bc3a44-a8c3-4277-ba3b-59dc0e4337d7",
      "name": "Parse Itinerary Response"
    },
    {
      "parameters": {
        "jsCode": "// Parse OpenAI itinerary response and format for cart processing (ACTIVITIES ONLY)\nconst openAIResponse = $input.first().json.choices[0].message.content;\nconst inputData = $('Sanitize Activities Data').first().json;\n\nlet itineraryData;\ntry {\n  // Remove markdown code blocks if present\n  let jsonString = openAIResponse.trim();\n  if (jsonString.startsWith('```json')) {\n    jsonString = jsonString.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n  } else if (jsonString.startsWith('```')) {\n    jsonString = jsonString.replace(/```\\n?/g, '');\n  }\n  \n  itineraryData = JSON.parse(jsonString);\n} catch (error) {\n  return [{\n    json: {\n      success: false,\n      message: \"Failed to parse OpenAI itinerary response\",\n      error: error.message,\n      raw_response: openAIResponse\n    }\n  }];\n}\n\n// Build itinerary with activities (no accommodation)\nconst itineraryWithActivities = itineraryData.itinerary.map(day => ({\n  day: day.day,\n  date: day.date,\n  city: day.city,\n  pax: day.pax,\n  activities: day.activities || []\n}));\n\n// Get the unique cart_reference, cart_name, and cart_title generated at the start of the flow\nconst cartReference = inputData.cart_reference;\nconst requestId = inputData.request_id;\nconst cartName = inputData.cart_name;  // Use shared cart name from \"Add Cart Metadata\"\nconst cartTitle = inputData.cart_title;  // Use shared cart title from \"Add Cart Metadata\"\n\n// Use the shared cart title as itinerary title\nconst itineraryTitle = cartTitle;\n\n// Count total activities\nconst totalActivities = itineraryWithActivities.reduce((sum, day) => sum + (day.activities?.length || 0), 0);\n\n// Format response for Laravel API\nconst formattedResponse = {\n  success: true,\n  message: \"Day-wise activities itinerary generated successfully\",\n  itinerary_title: itineraryTitle,\n  cart_name: cartName,\n  cart_reference: cartReference,\n  request_id: requestId,\n  itinerary: itineraryWithActivities,\n  travel_data: inputData.travel_data,\n  user_id: inputData.user_id,\n  force_new_cart: true,\n  metadata: {\n    total_days: itineraryWithActivities.length,\n    total_activities: totalActivities,\n    generated_at: new Date().toISOString(),\n    generation_method: \"OpenAI GPT-4o\",\n    note: \"Activities only - no hotels included\",\n    cart_reference: cartReference,\n    cart_name: cartName,\n    request_id: requestId\n  }\n};\n\nreturn [{\n  json: formattedResponse\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        -160
      ],
      "id": "56148135-afc3-4dd7-b42e-562a2f466e91",
      "name": "Parse Activities Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://dev-gateway.aahaas.com/api/automate/cart_process/hotels",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -208,
        -672
      ],
      "id": "9c3d66e5-3784-4796-ac4f-ce86af9533a2",
      "name": "Send to Hotels API"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.16.26.182:8000/api/automate/cart_process",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -208,
        0
      ],
      "id": "bb44a09c-1d7e-4a8b-9aba-e90d32cff25c",
      "name": "Send to Activities API"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -32,
        -320
      ],
      "id": "8f931c64-9ffd-448a-9de5-a7f8b18a48c6",
      "name": "Merge Both Responses"
    },
    {
      "parameters": {
        "jsCode": "// Combine hotels and activities responses\nconst inputs = $input.all();\nconst hotelsResponse = inputs.find(i => i.json.cart?.cart_title);\nconst activitiesResponse = inputs.find(i => i.json.cart && !hotelsResponse) || inputs[1];\n\nconst cartTitle = hotelsResponse?.json.cart?.cart_title || 'Your Travel Cart';\nconst cartId = hotelsResponse?.json.cart?.id || activitiesResponse?.json.cart?.id;\n\nreturn [{\n  json: {\n    message: `\"${cartTitle}\" has been created with both hotels and activities. Check your itinerary.`,\n    cart_id: cartId,\n    hotels_added: true,\n    activities_added: true,\n    success: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        -320
      ],
      "id": "54b4777c-a995-49a8-a61d-31a3640ec8fb",
      "name": "Combine Final Response"
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "Merge Input Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook API Trigger": {
      "main": [
        [
          {
            "node": "Extract Webhook Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Webhook Data": {
      "main": [
        [
          {
            "node": "Merge Input Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Input Sources": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Format for OpenAI Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for OpenAI Parser": {
      "main": [
        [
          {
            "node": "OpenAI Travel Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Travel Parser": {
      "main": [
        [
          {
            "node": "Parse Travel Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Travel Data": {
      "main": [
        [
          {
            "node": "Add Cart Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Activities Itinerary": {
      "main": [
        [
          {
            "node": "Parse Activities Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Activities Response": {
      "main": [
        [
          {
            "node": "Send to Activities API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Hotels API": {
      "main": [
        [
          {
            "node": "Merge Both Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Activities API": {
      "main": [
        [
          {
            "node": "Merge Both Responses",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Both Responses": {
      "main": [
        [
          {
            "node": "Combine Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Final Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Add Cart Metadata": {
      "main": [
        [
          {
            "node": "Process Cities & Hotel Rating",
            "type": "main",
            "index": 0
          },
          {
            "node": "Process Cities & Activities",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Cities & Hotel Rating": {
      "main": [
        [
          {
            "node": "Sanitize Hotels Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitize Hotels Data": {
      "main": [
        [
          {
            "node": "Build Itinerary Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Cities & Activities": {
      "main": [
        [
          {
            "node": "Sanitize Activities Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitize Activities Data": {
      "main": [
        [
          {
            "node": "Read Activities Excel List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Activities Excel List": {
      "main": [
        [
          {
            "node": "Match City Activities from Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match City Activities from Excel": {
      "main": [
        [
          {
            "node": "Merge Excel & AI Activities",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Excel & AI Activities": {
      "main": [
        [
          {
            "node": "Build Activities Itinerary Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Itinerary Prompt": {
      "main": [
        [
          {
            "node": "Generate Hotels Itinerary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Activities Itinerary Prompt": {
      "main": [
        [
          {
            "node": "Generate Activities Itinerary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Hotels Itinerary": {
      "main": [
        [
          {
            "node": "Parse Itinerary Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Itinerary Response": {
      "main": [
        [
          {
            "node": "Send to Hotels API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a90d8c70-92cc-4e47-9692-46b96e9464d6",
  "meta": {
    "instanceId": "9ba699815eee7a9b7506f6b264ee48edcb7b96a79c851198c7b7acafd2a5489c"
  },
  "id": "FvVabvP5WVxttTDD",
  "tags": []
}

