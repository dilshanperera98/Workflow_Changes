{
  "name": "Activities_Itinerary_20251107",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        -2592,
        -160
      ],
      "id": "95052549-28a7-4392-95c2-19f30e987e9d",
      "name": "When chat message received",
      "webhookId": "9d2612f3-b699-4bee-bda6-52b98551f2cf"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "127e3f0a-4469-48c8-996c-ab7c16ec18ce",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2592,
        64
      ],
      "id": "db929f92-9eeb-48b7-82bc-6020733fd42c",
      "name": "Webhook API Trigger",
      "webhookId": "127e3f0a-4469-48c8-996c-ab7c16ec18ce"
    },
    {
      "parameters": {
        "jsCode": "// Extract email_content and user_id from webhook body\nconst emailContent = $input.first().json.body?.email_content || $input.first().json.email_content || '';\nconst userId = $input.first().json.body?.user_id || $input.first().json.user_id || 'default-user';\n\nreturn [{\n  json: {\n    chatInput: emailContent,\n    sessionId: userId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2352,
        64
      ],
      "id": "e3ba2af5-a5cf-44ab-af5b-9d992235896c",
      "name": "Extract Webhook Data"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -304,
        -528
      ],
      "id": "50303627-9547-411f-b916-408ba51dd685",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Merge data from chat trigger (direct) or webhook (via Extract Webhook Data)\nconst chatInput = $input.first().json.chatInput;\nlet sessionId = $input.first().json.sessionId;\n\n// ============================================\n// üîß TESTING: Change the line below to test different session IDs\n// ============================================\n// OPTION 1: To test with specific ID, UNCOMMENT and change the value:\n// sessionId = \"655\";  // Change this to \"43\", \"655\", \"1234\", etc.\n\n// OPTION 2: To use actual input sessionId, keep the line above COMMENTED\n// ============================================\n\n// Ensure sessionId is an integer\n// For new chat sessions, use 1 as default\nif (!sessionId || sessionId === 'chat-session-' + Date.now()) {\n  sessionId = 1; // Default to 1 for new chat sessions\n} else if (typeof sessionId === 'string') {\n  // Try to parse if it's a numeric string\n  const parsed = parseInt(sessionId);\n  sessionId = isNaN(parsed) ? 1 : parsed;\n} else if (typeof sessionId !== 'number') {\n  sessionId = 1;\n}\n\n// CRITICAL: Generate unique request ID for EACH new chat message\n// This ensures SEPARATE carts for each request\nconst timestamp = Date.now();\nconst randomSuffix = Math.random().toString(36).substring(2, 9).toUpperCase();\nconst requestId = `REQ_${timestamp}_${randomSuffix}`;\nconst cartReference = `CART_${timestamp}_${randomSuffix}`;\n\nreturn [{\n  json: {\n    chatInput: chatInput,\n    sessionId: sessionId,  // Now guaranteed to be an integer\n    request_id: requestId,  // Unique per request\n    cart_reference: cartReference,  // Unique cart identifier\n    request_timestamp: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2336,
        -160
      ],
      "id": "79fbbb5f-7a32-4d75-bbf1-bb89af6782a8",
      "name": "Merge Input Sources"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"You are an expert travel planner specializing in route optimization and activity planning. Parse travel requests and provide comprehensive travel planning data with city-wise top activities in JSON format only.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"You are an expert travel planner. Parse the following travel request and provide comprehensive travel planning data with optimized routing.\\n\\nÔøΩ CRITICAL - FIRST RULE - READ THIS BEFORE PROCESSING ÔøΩ\\n\\nIF the request contains \\\"1 day\\\" or \\\"1 days\\\":\\n  THEN set total_nights = 1\\n  AND set destination array = [only 1 city]\\n  Example: \\\"I want to plan my 1 days sri lanka trip\\\" ‚Üí total_nights: 1, destination: [\\\"Colombo\\\"]\\n\\nELSE IF the request contains \\\"2 day\\\" or \\\"2 days\\\":\\n  THEN set total_nights = 1\\n  AND set destination array = [only 1 city]\\n  Example: \\\"I want to plan my 2 days sri lanka trip\\\" ‚Üí total_nights: 1, destination: [\\\"Colombo\\\"]\\n\\nELSE IF the request contains \\\"3 day\\\" or \\\"3 days\\\":\\n  THEN set total_nights = 2\\n  AND set destination array = [exactly 2 cities]\\n  Example: \\\"I want to plan my 3 days sri lanka trip\\\" ‚Üí total_nights: 2, destination: [\\\"Colombo\\\", \\\"Kandy\\\"]\\n  ‚ùå DO NOT use 3 cities\\n  ‚ùå DO NOT calculate 3-1=2\\n  ‚úÖ HARDCODE: total_nights = 2, cities = 2\\n\\nELSE (4 or more days):\\n  THEN calculate total_nights = days - 1\\n  AND use normal city selection logic\\n  Example: \\\"5 days trip\\\" ‚Üí total_nights: 4, destination: [3 cities by default]\\n\\nCRITICAL REQUIREMENTS:\\n1. Use current year (2025) for all dates if no year is specified\\n2. DURATION EXTRACTION - MANDATORY SPECIAL CASES (OVERRIDE ALL OTHER LOGIC):\\n   - Extract days if mentioned (e.g., 1 day, 2 days, 3 days, 8 days, 10 days)\\n   - ‚ö†Ô∏è SPECIAL CASE - 1 DAY (MANDATORY OVERRIDE):\\n     * Input: 1 day, 1 days, one day\\n     * Output: ALWAYS 1 night, ALWAYS 1 city\\n     * Ignore any city count requests\\n     * Example: I want to plan my 1 days sri lanka trip ‚Üí 1 night, 1 city (NOT 0 nights, NOT 3 cities)\\n   - ‚ö†Ô∏è SPECIAL CASE - 2 DAYS (MANDATORY OVERRIDE):\\n     * Input: 2 day, 2 days, two days\\n     * Output: ALWAYS 1 night, ALWAYS 1 city\\n     * Ignore any city count requests\\n     * Example: I want to plan my 2 days sri lanka trip ‚Üí 1 night, 1 city (NOT 2 cities)\\n   - ‚ö†Ô∏è SPECIAL CASE - 3 DAYS (MANDATORY OVERRIDE):\\n     * Input: 3 day, 3 days, three days\\n     * Output: ALWAYS 2 nights, ALWAYS 2 cities\\n     * Ignore default 3 cities, ignore any city count requests\\n     * Example: I want to plan my 3 days sri lanka trip ‚Üí 2 nights, 2 cities (NOT 7 nights, NOT 3 cities)\\n   - NORMAL CASE - 4+ DAYS ONLY:\\n     * Calculate nights = days - 1 (e.g., 4 days = 3 nights, 8 days = 7 nights, 10 days = 9 nights)\\n     * Apply normal city selection logic\\n   - DEFAULT: 9 NIGHTS (10 days) if not mentioned\\n3. CITY AND DAY COUNT EXTRACTION - CRITICAL:\\n   - STEP 1: Extract DAYS if mentioned (1 day, 2 days, 3 days, 5 days, etc.)\\n   - STEP 2: Extract CITY COUNT if mentioned (e.g., 5 cities, 4 cities, visit 3 cities)\\n   - STEP 3: DAY-BASED CITY LIMITING (CRITICAL):\\n     * ‚ö†Ô∏è MANDATORY SPECIAL CASES (HIGHEST PRIORITY - OVERRIDE EVERYTHING):\\n       - If 1 day mentioned ‚Üí FORCE 1 city, 1 night (ignore ALL other logic)\\n       - If 2 days mentioned ‚Üí FORCE 1 city, 1 night (ignore ALL other logic)\\n       - If 3 days mentioned ‚Üí FORCE 2 cities, 2 nights (ignore default 3, ignore ALL requests)\\n     * NORMAL CASE (4+ days ONLY):\\n       - max_cities = minimum of (requested_cities OR default_3, days_count)\\n     * Critical Examples:\\n       - Input: 1 day trip ‚Üí Output: 1 city, 1 night (MANDATORY)\\n       - Input: 2 days trip ‚Üí Output: 1 city, 1 night (MANDATORY)\\n       - Input: 3 days trip ‚Üí Output: 2 cities, 2 nights (MANDATORY, NOT 3 cities)\\n       - Input: 4 days trip ‚Üí Output: 3 nights, normal city logic\\n       - Input: 5 days in 3 cities ‚Üí Output: 4 nights, 3 cities (normal logic)\\n       - Input: 10 days trip ‚Üí Output: 9 nights, 3 cities default (normal logic)\\n   - Extract patterns: X day, X days, in X cities, visit X cities, X cities to visit\\n   - Single-city countries (Singapore, Monaco, Dubai): Always 1 city regardless\\n4. Calculate most efficient travel route between cities\\n5. CRITICAL FORMULA: Divide total nights by number of cities - Formula: nights_per_city = total_nights / city_count\\n6. First city gets base nights, Second city gets base nights, Third city gets base nights + remainder\\n7. INCLUDE city-wise top activities with GPS coordinates\\n8. Include GPS coordinates and check-in/check-out day numbers\\n\\nJSON FORMAT (respond with ONLY this JSON, no additional text):\\n\\n‚ö†Ô∏è BEFORE FILLING THIS JSON - CHECK DAY COUNT:\\n- Is it 1, 2, or 3 days? ‚Üí Use FORCED values from table above\\n- Is it 4+ days? ‚Üí Use normal calculation\\n\\n{\\n  \\\"destination\\\": [],\\n  \\\"optimized_route\\\": [],\\n  \\\"city_stays\\\": [],\\n  \\\"duration\\\": \\\"\\\",\\n  \\\"total_nights\\\": 0,\\n  \\\"travel_dates\\\": {\\\"start\\\": \\\"\\\", \\\"end\\\": \\\"\\\"},\\n  \\\"pax\\\": {\\n    \\\"adults\\\": 0,\\n    \\\"children\\\": 0,\\n    \\\"child_ages\\\": []\\n  },\\n  \\\"meal_plan\\\": \\\"\\\",\\n  \\\"hotel_category\\\": \\\"\\\",\\n  \\\"additional_requests\\\": \\\"\\\"\\n}\\n\\nFIELD INSTRUCTIONS:\\n\\n**destination**: Array of cities\\n- üî¥ SIMPLE RULE:\\n  * See \\\"1 day\\\" ‚Üí Use [1 city only]\\n  * See \\\"2 days\\\" ‚Üí Use [1 city only]\\n  * See \\\"3 days\\\" ‚Üí Use [2 cities only]\\n  * See \\\"4+ days\\\" ‚Üí Use normal city logic (default 3 or requested amount)\\n- Examples:\\n  * \\\"1 days sri lanka trip\\\" ‚Üí [\\\"Colombo\\\"]\\n  * \\\"2 days sri lanka trip\\\" ‚Üí [\\\"Colombo\\\"]\\n  * \\\"3 days sri lanka trip\\\" ‚Üí [\\\"Colombo\\\", \\\"Kandy\\\"] (NOT 3 cities)\\n  * \\\"5 days in 3 cities\\\" ‚Üí [\\\"Colombo\\\", \\\"Kandy\\\", \\\"Galle\\\"]\\n  * \\\"10 days trip\\\" ‚Üí [\\\"Colombo\\\", \\\"Kandy\\\", \\\"Galle\\\"] (default 3)\\n- DO NOT include country name in this array\\n- Single-city countries (Singapore, Monaco, Dubai): Always [city name] only\\n- Standard Examples (4+ days without day limiting):\\n  * Input: Singapore trip ‚Üí [Singapore] (single-city country)\\n  * Input: Sri Lanka trip ‚Üí [Colombo, Kandy, Galle] (default 3 cities)\\n  * Input: Sri Lanka in 5 cities ‚Üí [Colombo, Kandy, Galle, Ella, Nuwara Eliya] (5 cities as requested)\\n  * Input: Thailand visit 4 cities ‚Üí [Bangkok, Chiang Mai, Phuket, Krabi] (4 cities)\\n  * Input: India trip ‚Üí [Delhi, Agra, Jaipur] (default 3 cities)\\n\\n**optimized_route**: Array of cities in most efficient travel order\\n- Single city: [\\\"Singapore\\\"]\\n- Multiple cities: Analyze geographical locations, arrange to minimize backtracking\\n- Example: [\\\"Colombo\\\", \\\"Kandy\\\", \\\"Galle\\\"] (airport city first, then nearby, then final)\\n\\n**total_nights**: Extract or calculate total number of nights\\n- üî¥ SIMPLE RULE:\\n  * See \\\"1 day\\\" ‚Üí Write 1\\n  * See \\\"2 days\\\" ‚Üí Write 1\\n  * See \\\"3 days\\\" ‚Üí Write 2\\n  * See \\\"4+ days\\\" ‚Üí Calculate days - 1\\n- Examples:\\n  * \\\"1 days sri lanka trip\\\" ‚Üí total_nights: 1\\n  * \\\"2 days sri lanka trip\\\" ‚Üí total_nights: 1\\n  * \\\"3 days sri lanka trip\\\" ‚Üí total_nights: 2\\n  * \\\"4 days trip\\\" ‚Üí total_nights: 3 (4-1)\\n  * \\\"8 days trip\\\" ‚Üí total_nights: 7 (8-1)\\n  * No mention ‚Üí total_nights: 9 (default)\\n- This is a NUMBER (integer)\\n\\n**city_stays**: Array with stay information - LENGTH matches destination array\\n- SINGLE CITY: [{city: Singapore, nights: 9, order: 1, check_in_day: 1, check_out_day: 10}]\\n\\n- MULTI-CITY CALCULATION (dynamic based on city count):\\n  * city_count = number of cities in destination array\\n  * base_nights = Math.floor(total_nights / city_count)\\n  * remainder = total_nights % city_count\\n  * Distribute: Each city gets base_nights, last city gets base_nights + remainder\\n\\n- CALCULATION EXAMPLES:\\n  * 9 nights / 3 cities: 9/3 = 3 base, 0 remainder ‚Üí [3, 3, 3]\\n  * 9 nights / 5 cities: 9/5 = 1 base, 4 remainder ‚Üí [1, 1, 1, 1, 5]\\n  * 12 nights / 4 cities: 12/4 = 3 base, 0 remainder ‚Üí [3, 3, 3, 3]\\n  * 10 nights / 5 cities: 10/5 = 2 base, 0 remainder ‚Üí [2, 2, 2, 2, 2]\\n  * 7 nights / 3 cities: 7/3 = 2 base, 1 remainder ‚Üí [2, 2, 3]\\n\\n- Include check-in and check-out day numbers:\\n  * City 1: check_in_day = 1, check_out_day = 1 + nights\\n  * City 2: check_in_day = City 1's check_out_day, check_out_day = check_in_day + nights\\n  * City 3: check_in_day = City 2's check_out_day, check_out_day = check_in_day + nights\\n\\n**duration**: \\n- Format as \\\"X days Y nights\\\"\\n- DEFAULT: \\\"10 days 9 nights\\\" if not mentioned\\n- Calculate days = nights + 1\\n\\n**travel_dates**:\\n- Extract start and end dates in YYYY-MM-DD format\\n- CRITICAL DEFAULT: If no dates provided, use TODAY + 15 DAYS as start date\\n  * Current date: \" + new Date().toISOString().slice(0,10) + \"\\n  * Default start: \" + new Date(Date.now() + 15*24*60*60*1000).toISOString().slice(0,10) + \" (today + 15 days)\\n- IMPORTANT: If no year mentioned, use \" + new Date().getFullYear() + \"\\n- Calculate end date: start_date + total_nights\\n- Example: 9 nights from \" + new Date(Date.now() + 15*24*60*60*1000).toISOString().slice(0,10) + \" ‚Üí start: \\\"\" + new Date(Date.now() + 15*24*60*60*1000).toISOString().slice(0,10) + \"\\\", end: \\\"\" + new Date(Date.now() + 24*24*60*60*1000).toISOString().slice(0,10) + \"\\\"\\n\\n**pax**:\\n- CRITICAL: Extract adult and child counts from the request\\n- adults: Count of adults (integer) - DEFAULT 1 if not specified\\n- children: Count of children (integer) - DEFAULT 0 if not specified\\n- child_ages: Array of child ages (numbers) if mentioned\\n\\n- EXTRACTION RULES:\\n  * Look for numbers before words: adult/adults, child/children, kid/kids\\n  * Variations: adult, adults, child, children, kid, kids, Child, Children\\n  * Extract the NUMBER that appears before these words\\n  * If NO adults/children mentioned ‚Üí adults=1, children=0\\n\\n- EXTRACTION EXAMPLES:\\n  * Input: 3 adult 2 Child ‚Üí adults: 3, children: 2\\n  * Input: 3 adults 2 children ‚Üí adults: 3, children: 2\\n  * Input: for 3 adult ‚Üí adults: 3, children: 0\\n  * Input: 2 adults ‚Üí adults: 2, children: 0\\n  * Input: 1 adult 1 child age 5 ‚Üí adults: 1, children: 1, child_ages: [5]\\n  * Input: 4 adults 3 kids ‚Üí adults: 4, children: 3\\n  * Input: Sri Lanka trip (no pax mentioned) ‚Üí adults: 1, children: 0\\n\\n**meal_plan**: \\n- CRITICAL DEFAULT: \\\"BB\\\" (Bed & Breakfast) - ALWAYS use BB if customer doesn't specify\\n- Valid options ONLY if explicitly mentioned: \\\"BB\\\", \\\"HB\\\", \\\"FB\\\", \\\"AI\\\"\\n\\n**hotel_category**: \\n- DEFAULT: \\\"4-Star\\\" if not mentioned\\n\\n**additional_requests**: Special requirements, dietary needs, transport preferences\\n\\nDETAILED EXAMPLES:\\n\\n**Example 1: Sri Lanka - 3 ADULTS (9 nights, 3 cities)**\\nCustomer: I want to plan a trip for Sri Lanka for 3 adult. Give me travel quotation\\nPax Extraction: 3 adult ‚Üí adults: 3, children: 0\\nTop 3 Cities: Colombo, Kandy, Galle\\nDefault: 10 days 9 nights, Start: November 22, 2025 (today + 15 days)\\nCalculation: 9 nights / 3 cities = 3 nights each (no remainder)\\nDistribution:\\n- Colombo: 3 nights, Check-in Nov 22, Check-out Nov 25 (ONE hotel)\\n- Kandy: 3 nights, Check-in Nov 25, Check-out Nov 28 (ONE hotel)\\n- Galle: 3 nights, Check-in Nov 28, Check-out Dec 1 (ONE hotel)\\n\\n**Example 2: Singapore - SINGLE CITY (9 nights)**\\nCustomer: \\\"Singapore trip for 2 adults\\\"\\nSingle City: Singapore\\nDefault: 10 days 9 nights\\nCalculation: ALL 9 nights in Singapore\\nDistribution:\\n- Singapore: 9 nights, Check-in Nov 22, Check-out Dec 1 (ONE hotel for entire stay)\\n\\n**Example 3: Sri Lanka - 8 DAYS (7 nights, 3 cities)**\\nCustomer: Sri Lanka for 8 days\\nDays to Nights: 8 days = 7 nights\\nCalculation: 7 nights / 3 = 2 base, 1 remainder ‚Üí [2, 2, 3]\\nDistribution:\\n- Colombo: 2 nights, Day 1-3\\n- Kandy: 2 nights, Day 3-5\\n- Galle: 3 nights, Day 5-8\\n\\n**Example 4: Thailand - 3 ADULTS 2 CHILDREN**\\nCustomer: Thailand trip for 3 adults 2 children\\nPax Extraction: adults = 3, children = 2\\nTop 3 Cities: Bangkok, Chiang Mai, Phuket\\nDefault: 10 days 9 nights (9 divided by 3 = 3 nights each)\\nDistribution: Bangkok 3 nights, Chiang Mai 3 nights, Phuket 3 nights\\nJSON pax format: adults 3, children 2, child_ages empty array\\n\\n**Example 5: Sri Lanka - 3 ADULT 2 CHILD (with mixed case)**\\nCustomer: i want to plan a trip for Srilanka for 3 adult 2 Child to trip\\nPax Extraction: 3 adult 2 Child ‚Üí adults: 3, children: 2\\nTop 3 Cities: Colombo, Kandy, Galle\\nDefault: 10 days 9 nights\\nJSON pax: adults=3, children=2, child_ages=[]\\n\\n**Example 6: Sri Lanka - 5 CITIES (dynamic city count)**\\nCustomer: I want to plan to sri lanka with my 5 people and stay and visit in 5 cities\\nCity Count Extraction: in 5 cities ‚Üí city_count: 5\\nPax Extraction: 5 people ‚Üí adults: 5, children: 0\\nTop 5 Cities: Colombo, Kandy, Galle, Ella, Nuwara Eliya\\nDefault: 10 days 9 nights\\nCalculation: 9 nights / 5 cities = 1 base, 4 remainder ‚Üí [1, 1, 1, 1, 5]\\nDistribution:\\n- Colombo: 1 night, Day 1-2\\n- Kandy: 1 night, Day 2-3\\n- Galle: 1 night, Day 3-4\\n- Ella: 1 night, Day 4-5\\n- Nuwara Eliya: 5 nights, Day 5-10\\n\\n**Example 7: Sri Lanka - NO CITY COUNT (default 3)**\\nCustomer: I want to plan to sri lanka with my 5 people and stay and visit\\nCity Count: Not mentioned ‚Üí DEFAULT 3 cities\\nPax Extraction: 5 people ‚Üí adults: 5, children: 0\\nTop 3 Cities: Colombo, Kandy, Galle\\nCalculation: 9 nights / 3 cities = 3 each ‚Üí [3, 3, 3]\\n\\n**Example 8: Sri Lanka - 1 DAY TRIP (SPECIAL CASE)**\\nCustomer: I want to plan my 1 days sri lanka trip\\nDay Extraction: 1 day ‚Üí SPECIAL CASE\\nNights Calculation: 1 day ‚Üí 1 night (special case override)\\nCity Limiting: 1 day ‚Üí EXACTLY 1 city (special case)\\nCity Selection: [Colombo] (1 city only)\\nPax: Not mentioned ‚Üí adults: 1, children: 0\\nTotal: 1 day, 1 night\\nDistribution: Colombo (1 night, Day 1-2)\\nJSON city_stays: [{city: Colombo, nights: 1, order: 1, check_in_day: 1, check_out_day: 2}]\\nHotel: 1 hotel in Colombo (1 night stay)\\n\\n**Example 9: Sri Lanka - 2 DAYS TRIP (SPECIAL CASE)**\\nCustomer: I want to plan my 2 days sri lanka trip\\nDay Extraction: 2 days ‚Üí SPECIAL CASE\\nNights Calculation: 2 days ‚Üí 1 night (special case override)\\nCity Limiting: 2 days ‚Üí EXACTLY 1 city (special case)\\nCity Selection: [Colombo] (1 city only)\\nPax: Not mentioned ‚Üí adults: 1, children: 0\\nTotal: 2 days, 1 night\\nDistribution: Colombo (1 night, Day 1-2)\\nJSON city_stays: [{city: Colombo, nights: 1, order: 1, check_in_day: 1, check_out_day: 2}]\\nHotel: 1 hotel in Colombo (1 night stay)\\n\\n**Example 10: Sri Lanka - 3 DAYS TRIP (MANDATORY SPECIAL CASE)**\\nCustomer: I want to plan my 3 days sri lanka trip\\nDay Extraction: 3 days ‚Üí ‚ö†Ô∏è MANDATORY SPECIAL CASE DETECTED\\nNights Calculation: 3 days ‚Üí FORCE 2 nights (NOT 7 nights, NOT 3 nights, NOT days-1)\\nCity Limiting: 3 days ‚Üí FORCE 2 cities (NOT 3 cities, OVERRIDE default)\\nCity Selection: [Colombo, Kandy] (EXACTLY 2 cities, NOT [Colombo, Kandy, Galle])\\nPax: Not mentioned ‚Üí adults: 1, children: 0\\nCalculation: 2 nights / 2 cities = 1 night each ‚Üí [1, 1]\\nDistribution:\\n- Colombo: 1 night, Day 1-2\\n- Kandy: 1 night, Day 2-3\\nJSON city_stays: [{city: Colombo, nights: 1, check_in_day: 1, check_out_day: 2}, {city: Kandy, nights: 1, check_in_day: 2, check_out_day: 3}]\\nJSON total_nights: 2 (NOT 7, NOT 3)\\nJSON destination: [Colombo, Kandy] (2 cities, NOT 3)\\nHotels: 1 hotel in Colombo (1 night) + 1 hotel in Kandy (1 night) = 2 hotels total\\n‚ö†Ô∏è CRITICAL: This is MANDATORY override - do NOT use days-1 formula, do NOT use default 3 cities\\n\\n**Example 11: Sri Lanka - 1 DAY in 5 CITIES (special case overrides request)**\\nCustomer: plan 1 day trip to sri lanka visit 5 cities\\nDay Extraction: 1 day ‚Üí SPECIAL CASE\\nCity Request: 5 cities (ignored due to special case)\\nNights: 1 night (special case)\\nCity Limiting: 1 day ‚Üí EXACTLY 1 city (special case overrides request)\\nCity Selection: [Colombo] (special case wins, ignores 5 cities request)\\nDistribution: Colombo (1 night)\\nHotel: 1 hotel only\\nRationale: 1 day is special case, always 1 city, 1 night\\n\\n**Example 12: Sri Lanka - 2 DAYS in 4 CITIES (special case overrides request)**\\nCustomer: plan 2 days trip visit 4 cities\\nDay Extraction: 2 days ‚Üí SPECIAL CASE\\nCity Request: 4 cities (ignored due to special case)\\nNights: 1 night (special case)\\nCity Limiting: 2 days ‚Üí EXACTLY 1 city (special case overrides request)\\nCity Selection: [Colombo] (special case wins, ignores 4 cities request)\\nDistribution: Colombo (1 night)\\nHotel: 1 hotel only\\nRationale: 2 days is special case, always 1 city, 1 night\\n\\n**Example 13: Sri Lanka - 3 DAYS in 5 CITIES (special case overrides request)**\\nCustomer: plan 3 days trip visit 5 cities\\nDay Extraction: 3 days ‚Üí SPECIAL CASE\\nCity Request: 5 cities (ignored due to special case)\\nNights: 2 nights (special case)\\nCity Limiting: 3 days ‚Üí EXACTLY 2 cities (special case overrides request)\\nCity Selection: [Colombo, Kandy] (special case wins, ignores 5 cities request)\\nCalculation: 2 nights / 2 cities = 1 each ‚Üí [1, 1]\\nDistribution: Colombo (1 night), Kandy (1 night)\\nHotels: 2 hotels total\\nRationale: 3 days is special case, always 2 cities, 2 nights\\n\\n**Example 14: Sri Lanka - 5 DAYS in 3 CITIES (normal case, no special handling)**\\nCustomer: plan 5 days in sri lanka visit 3 cities\\nDay Extraction: 5 days ‚Üí NORMAL CASE (4+ days)\\nNights: 5 days ‚Üí 4 nights (days - 1)\\nCity Request: 3 cities\\nCity Limiting: max_cities = min(3, 5) = 3 cities (request within day limit)\\nCity Selection: [Colombo, Kandy, Galle] (normal calculation)\\nCalculation: 4 nights / 3 cities = 1 base, 1 remainder ‚Üí [1, 1, 2]\\nDistribution:\\n- Colombo: 1 night, Day 1-2\\n- Kandy: 1 night, Day 2-3\\n- Galle: 2 nights, Day 3-5\\nHotels: 3 hotels total (1 per city)\\n\\nCRITICAL - INCLUDE ACTIVITIES:\\n- INCLUDE \\\"activities\\\" field with city-wise top attractions\\n- Focus on popular activities, cultural sites, and experiences\\n- Include GPS coordinates (latitude, longitude) for each activity\\n\\nEMAIL CONTENT TO PARSE:\\n\" + $json.output + \"\\n\\nÔøΩ SIMPLE RULE - MEMORIZE THIS ÔøΩ\\n\\nDays Mentioned ‚Üí Nights to Use ‚Üí Cities to Use\\n1 day        ‚Üí 1 night      ‚Üí 1 city\\n2 days       ‚Üí 1 night      ‚Üí 1 city\\n3 days       ‚Üí 2 nights     ‚Üí 2 cities\\n4+ days      ‚Üí days - 1     ‚Üí normal logic\\n\\nExample Test Case:\\nInput: \\\"I want to plan my 3 days sri lanka trip\\\"\\nYour Response Must Be:\\n  total_nights: 2 (not 3, not 7)\\n  destination: [\\\"Colombo\\\", \\\"Kandy\\\"] (2 cities, not 3)\\n  city_stays: [{city: Colombo, nights: 1}, {city: Kandy, nights: 1}]\\n\\nRemember:\\n- Current date: \" + new Date().toISOString().slice(0,10) + \"\\n- Default: 9 NIGHTS (10 days) if not specified\\n- Default start date: TODAY + 15 DAYS (\" + new Date(Date.now() + 15*24*60*60*1000).toISOString().slice(0,10) + \")\\n- üî¥ DAY COUNT RULE (APPLY FIRST):\\n  1 day  = 1 night + 1 city\\n  2 days = 1 night + 1 city\\n  3 days = 2 nights + 2 cities\\n  4+ days = (days-1) nights + normal city logic\\n- CRITICAL CITY COUNT EXTRACTION (for 4+ days only):\\n    - STEP 1: Extract days (4 days, 5 days, 10 days, etc.)\\n    - STEP 2: Extract city count (in 5 cities, visit 3 cities, etc.) or use default 3\\n    - STEP 3: Apply formula: max_cities = min(requested_cities OR 3, days_count)\\n  * Examples:\\n    - 1 day ‚Üí 1 city, 1 night (special case)\\n    - 2 days ‚Üí 1 city, 1 night (special case)\\n    - 3 days ‚Üí 2 cities, 2 nights (special case)\\n    - 1 day in 5 cities ‚Üí 1 city, 1 night (special case overrides request)\\n    - 2 days in 4 cities ‚Üí 1 city, 1 night (special case overrides)\\n    - 3 days in 5 cities ‚Üí 2 cities, 2 nights (special case overrides)\\n    - 5 days in 3 cities ‚Üí 3 cities, 4 nights (normal case)\\n    - 10 days ‚Üí 3 cities default, 9 nights (normal case)\\n- CRITICAL CITY COUNT EXTRACTION:\\n  * Look for: in X cities, visit X cities, X cities to visit\\n  * If mentioned: Use that exact number (e.g., in 5 cities ‚Üí select TOP 5)\\n  * If NOT mentioned: DEFAULT to TOP 3 cities\\n  * THEN apply day-based limiting (special cases take priority)\\n  * Example: in 5 cities ‚Üí Colombo, Kandy, Galle, Ella, Nuwara Eliya\\n  * Example: no city count ‚Üí Colombo, Kandy, Galle (default 3)\\n  * Example: 1 day in 5 cities ‚Üí Colombo (special case = 1 city, 1 night)\\n  * Example: 2 days in 4 cities ‚Üí Colombo (special case = 1 city, 1 night)\\n  * Example: 3 days in 5 cities ‚Üí Colombo, Kandy (special case = 2 cities, 2 nights)\\n- CRITICAL PAX EXTRACTION:\\n  * Default: adults=1, children=0 if NOT mentioned\\n  * Extract NUMBER before adult/adults/child/children/kid/kids/Child/people\\n  * Example: 5 people ‚Üí adults:5, children:0\\n  * Example: 3 adult 2 Child ‚Üí adults:3, children:2\\n  * Example: for 3 adult ‚Üí adults:3, children:0\\n  * Example: no mention ‚Üí adults:1, children:0\\n- Default: BB meal plan, 4-Star hotel\\n- Singapore/single-city countries: ONE city, ALL nights in ONE hotel\\n- Multi-city calculation: base = Math.floor(total_nights/city_count), remainder = total_nights % city_count\\n- Last city gets remainder nights: base_nights + remainder\\n- Each city = ONE hotel for ALL nights in that city\\n- Respond with ONLY valid JSON, no markdown\\n\\nüö® FINAL VERIFICATION BEFORE RESPONDING üö®\\nBefore sending your response, verify:\\n‚ñ° If input has \\\"1 day\\\" ‚Üí total_nights is 1 (NOT 0)\\n‚ñ° If input has \\\"2 days\\\" ‚Üí total_nights is 1 (NOT 2)\\n‚ñ° If input has \\\"3 days\\\" ‚Üí total_nights is 2 (NOT 3, NOT 7)\\n‚ñ° If input has \\\"3 days\\\" ‚Üí destination has 2 cities (NOT 3)\\n‚ñ° If input has \\\"4+ days\\\" ‚Üí total_nights is days - 1\\n\\nIf any checkbox fails, FIX IT before responding.\"\n    }\n  ],\n  \"temperature\": 0.7\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1712,
        -368
      ],
      "id": "02faf066-c178-439c-85ed-5911ae2489d9",
      "name": "OpenAI Travel Parser",
      "credentials": {
        "openAiApi": {
          "id": "CYHGS3KAjICCaQqY",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse OpenAI JSON response and format like the old HTTP endpoint\nconst openAIResponse = $input.first().json.choices[0].message.content;\nconst inputData = $('Format for OpenAI Parser').first().json;\n\nlet travelData;\ntry {\n  // Try to parse the response as JSON\n  // Remove markdown code blocks if present\n  let jsonString = openAIResponse.trim();\n  if (jsonString.startsWith('```json')) {\n    jsonString = jsonString.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n  } else if (jsonString.startsWith('```')) {\n    jsonString = jsonString.replace(/```\\n?/g, '');\n  }\n  \n  travelData = JSON.parse(jsonString);\n} catch (error) {\n  // If parsing fails, return error\n  return [{\n    json: {\n      success: false,\n      message: \"Failed to parse OpenAI response\",\n      error: error.message,\n      raw_response: openAIResponse\n    }\n  }];\n}\n\n// CRITICAL: Remove country name from destination array if present\nif (travelData.destination && Array.isArray(travelData.destination)) {\n  // List of common countries to filter out\n  const countries = [\n    'Sri Lanka', 'Thailand', 'Singapore', 'Malaysia', 'Indonesia', 'Vietnam',\n    'Philippines', 'Myanmar', 'Cambodia', 'Laos', 'India', 'China', 'Japan',\n    'South Korea', 'UAE', 'United Arab Emirates', 'Maldives', 'Nepal', 'Bhutan',\n    'Pakistan', 'Bangladesh', 'Australia', 'New Zealand', 'USA', 'United States',\n    'UK', 'United Kingdom', 'France', 'Germany', 'Italy', 'Spain', 'Switzerland'\n  ];\n  \n  // Remove country name from destination array\n  travelData.destination = travelData.destination.filter(dest => {\n    return !countries.some(country => \n      dest.toLowerCase().trim() === country.toLowerCase().trim()\n    );\n  });\n}\n\n// Format response to match the old HTTP endpoint structure\nconst formattedResponse = {\n  success: true,\n  message: \"Travel itinerary parsed successfully\",\n  travel_data: travelData,\n  suggestions: [\n    `Optimized route: ${travelData.optimized_route?.join(' ‚Üí ') || 'Route calculated'}`,\n    `${travelData.city_stays?.length || 0} cities with ${travelData.duration || 'planned'} duration`,\n    `Meal plan: ${travelData.meal_plan || 'BB'}`,\n    `Hotel category: ${travelData.hotel_category || '4-Star'}`\n  ],\n  metadata: {\n    email_length: (inputData.output || '').length,\n    parsed_at: new Date().toISOString(),\n    destinations_count: travelData.destination?.length || 0,\n    city_stays_count: travelData.city_stays?.length || 0,\n    total_nights: travelData.city_stays?.reduce((sum, city) => sum + (city.nights || 0), 0) || 0,\n    route_optimized: true,\n    suggestions_provided: 4,\n    enhancement_level: \"route-optimized\"\n  }\n};\n\nreturn [{\n  json: formattedResponse\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1504,
        -368
      ],
      "id": "32b3a8f3-7a40-408f-b32c-a2ff9d6ba56d",
      "name": "Parse OpenAI Response"
    },
    {
      "parameters": {
        "jsCode": "// Process travel data: extract activity preferences and create city-wise activity data\nconst httpRequest1Data = $input.first().json;\n\n// Create a deep copy to avoid mutation\nlet processedData = JSON.parse(JSON.stringify(httpRequest1Data));\n\n// Extract activity preferences (replaces hotel star rating)\nif (processedData.travel_data) {\n  // Set activity preferences from budget level or use default\n  processedData.travel_data.activity_preferences = processedData.travel_data.activity_preferences || 'popular_attractions';\n  processedData.travel_data.budget_level = processedData.travel_data.budget_level || 'mid-range';\n}\n\n// CRITICAL: Build destination array and activity focus for each city\nif (processedData.travel_data && processedData.travel_data.city_stays && Array.isArray(processedData.travel_data.city_stays)) {\n  const cityStays = processedData.travel_data.city_stays;\n  \n  // Build destination array with ALL cities\n  const destinations = cityStays.map(cityStay => cityStay.city);\n  processedData.travel_data.destination = destinations;\n  \n  // Create detailed city information for activities\n  processedData.travel_data.city_details = cityStays.map(cityStay => ({\n    city: cityStay.city,\n    nights: cityStay.nights,\n    order: cityStay.order,\n    check_in_day: cityStay.check_in_day,\n    check_out_day: cityStay.check_out_day,\n    coordinates: cityStay.coordinates,\n    activity_focus: 'top_attractions',\n    days_in_city: cityStay.nights + 1\n  }));\n  \n  // Store important metadata\n  processedData.travel_data.total_cities = cityStays.length;\n  processedData.travel_data.total_nights = cityStays.reduce((sum, city) => sum + city.nights, 0);\n  processedData.travel_data.activity_summary = {\n    total_cities: cityStays.length,\n    total_days: cityStays.reduce((sum, city) => sum + (city.nights + 1), 0),\n    activity_details: cityStays.map(city => `${city.city}: ${city.nights + 1} days of activities`)\n  };\n}\n\nreturn [{\n  json: processedData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1312,
        -368
      ],
      "id": "d6bd4dec-fd94-4780-bb35-26c3a7f9a294",
      "name": "Process Cities & Activities"
    },
    {
      "parameters": {
        "jsCode": "// Add user_id and cart_reference to the data from HTTP Request1\n\nconst httpRequest1Data = $input.first().json;\nconst mergeInputData = $('Merge Input Sources').first().json;\n\nlet userId = mergeInputData.sessionId;\n\n// Convert userId to integer\n// If it's a string like 'chat-session-123' or 'default-user', default to 1\n// If it's already a number or numeric string, parse it\nif (typeof userId === 'string') {\n  // Try to extract number from string\n  const numMatch = userId.match(/\\d+/);\n  if (numMatch) {\n    userId = parseInt(numMatch[0]);\n  } else {\n    // Default to 1 if no number found\n    userId = 1;\n  }\n} else if (typeof userId === 'number') {\n  userId = Math.floor(userId); // Ensure it's an integer\n} else {\n  // Default to 1 if userId is undefined or other type\n  userId = 1;\n}\n\n// Merge user_id and cart_reference with the existing data\nconst dataWithUserId = {\n  ...httpRequest1Data,\n  user_id: userId,  // Now guaranteed to be an integer\n  cart_reference: mergeInputData.cart_reference,  // Unique cart identifier\n  request_id: mergeInputData.request_id,  // Unique request identifier\n  request_timestamp: mergeInputData.request_timestamp\n};\n\nreturn [{\n  json: dataWithUserId\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        -368
      ],
      "id": "47a576f0-0daf-436e-b567-780d1707ba99",
      "name": "Add User ID"
    },
    {
      "parameters": {
        "jsCode": "// Sanitize data before sending to Laravel API\nconst inputData = $input.first().json;\n\n// Function to clean strings - remove control characters\nfunction cleanString(str) {\n  if (typeof str !== 'string') return str;\n  // Remove control characters except newlines and tabs, then escape properly\n  return str.replace(/[\\x00-\\x08\\x0B-\\x0C\\x0E-\\x1F\\x7F]/g, '');\n}\n\n// Function to recursively clean all strings in an object\nfunction cleanObject(obj) {\n  if (obj === null || obj === undefined) return obj;\n  \n  if (typeof obj === 'string') {\n    return cleanString(obj);\n  }\n  \n  if (Array.isArray(obj)) {\n    return obj.map(item => cleanObject(item));\n  }\n  \n  if (typeof obj === 'object') {\n    const cleaned = {};\n    for (const key in obj) {\n      if (obj.hasOwnProperty(key)) {\n        cleaned[key] = cleanObject(obj[key]);\n      }\n    }\n    return cleaned;\n  }\n  \n  return obj;\n}\n\n// Clean the entire data object\nconst sanitizedData = cleanObject(inputData);\n\nreturn [{\n  json: sanitizedData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -944,
        -368
      ],
      "id": "188be9b6-fa8b-4a4e-a43e-b1c6d55d1f6e",
      "name": "Sanitize Data"
    },
    {
      "parameters": {
        "jsCode": "// Build OpenAI prompt for ACTIVITIES-ONLY itinerary generation\nconst inputData = $input.first().json;\nconst data = inputData.travel_data;\n\nconst destination = data.destination?.[0] || 'Unknown';\nconst startDate = data.travel_dates?.start || '';\nconst endDate = data.travel_dates?.end || '';\nconst duration = data.duration || '';\nconst adults = data.pax?.adults || 1;\nconst children = data.pax?.children || 0;\nconst childAges = data.pax?.child_ages || [];\nconst activityPreferences = data.activity_preferences || 'popular_attractions';\nconst budgetLevel = data.budget_level || 'mid-range';\n\n// Get cities from city_details\nconst cities = data.city_details || [];\nconst citiesStr = cities.map(c => `${c.city} (${c.days_in_city} days)`).join(', ');\n\n// Calculate total days\nconst start = new Date(startDate);\nconst end = new Date(endDate);\nconst totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;\n\n// Build city stays breakdown\nconst cityStaysBreakdown = cities.map(c => `- ${c.city}: ${c.days_in_city} days (Day ${c.check_in_day}-${c.check_out_day}) at ${c.coordinates}`).join('\\n');\n\nconst lastCity = cities[cities.length - 1]?.city || 'last city';\nconst citiesRoute = cities.map(c => c.city).join(' ‚Üí ');\n\n// Build the complete prompt for ACTIVITIES\nconst userPrompt = `You are an expert travel planner. Create a detailed day-by-day ACTIVITIES itinerary for a ${totalDays}-day trip.\\n\\nIMPORTANT: ACTIVITIES ONLY - DO NOT include accommodation/hotels!\\n\\nTRIP DETAILS:\\n- Cities: ${citiesStr}\\n- Duration: ${duration} (${startDate} to ${endDate})\\n- Total Days: ${totalDays}\\n- Travelers: ${adults} adults, ${children} children\\n- Child Ages: ${JSON.stringify(childAges)}\\n- Activity Preferences: ${activityPreferences}\\n- Budget Level: ${budgetLevel}\\n\\nCITY BREAKDOWN:\\n${cityStaysBreakdown}\\n\\nCRITICAL REQUIREMENTS:\\n\\n1. ACTIVITIES ONLY - NO HOTELS:\\n   - DO NOT include accommodation/hotel information\\n   - FOCUS on activities, attractions, experiences\\n   - Include activities array for each day\\n\\n2. PAX OBJECT (MANDATORY):\\n   - EVERY day MUST include pax object: {\\\"adults\\\": ${adults}, \\\"children\\\": ${children}, \\\"child_ages\\\": ${JSON.stringify(childAges)}}\\n\\n3. CITY-WISE TOP ACTIVITIES:\\n   - List MAXIMUM 3 top activities PER DAY (no more than 3)\\n   - Include GPS coordinates (latitude, longitude) for EACH activity\\n   - Activity categories with sub_category_id mapping:\\n     * Adventure = 1\\n     * Entertainment = 2\\n     * Health & Wellness = 3\\n     * Event = 4\\n     * Tours = 5\\n     * Transport = 6\\n     * Services = 7\\n     * Tickets = 8\\n     * Culinary = 9\\n     * Experience = 10\\n     * Vacation Packages = 46\\n   - Include estimated duration and best time to visit\\n\\n4. ACTIVITY OBJECT (MANDATORY FIELDS):\\n   - activity_name: string (name of attraction/activity)\\n   - category: string (Adventure/Entertainment/Health & Wellness/Event/Tours/Transport/Services/Tickets/Culinary/Experience/Vacation Packages)\\n   - sub_category_id: integer (MANDATORY - use mapping above based on category)\\n   - description: string (brief description)\\n   - duration: string (e.g., \\\"2-3 hours\\\", \\\"half day\\\", \\\"full day\\\")\\n   - latitude: number (GPS coordinate)\\n   - longitude: number (GPS coordinate)\\n   - best_time: string (e.g., \\\"morning\\\", \\\"afternoon\\\", \\\"evening\\\", \\\"anytime\\\")\\n   - cost_level: string (\\\"free\\\", \\\"low\\\", \\\"medium\\\", \\\"high\\\")\\n\\n5. CITY-BASED PLANNING:\\n   - Respect the city schedule: ${citiesRoute}\\n\\nREQUIRED JSON STRUCTURE (ACTIVITIES ONLY):\\n\\n{\\n  \\\"itinerary\\\": [\\n    {\\n      \\\"day\\\": 1,\\n      \\\"date\\\": \\\"${startDate}\\\",\\n      \\\"city\\\": \\\"${cities[0]?.city || 'City Name'}\\\",\\n      \\\"pax\\\": {\\n        \\\"adults\\\": ${adults},\\n        \\\"children\\\": ${children},\\n        \\\"child_ages\\\": ${JSON.stringify(childAges)}\\n      },\\n      \\\"activities\\\": [\\n        {\\n          \\\"activity_name\\\": \\\"Temple of the Sacred Tooth Relic\\\",\\n          \\\"category\\\": \\\"Tours\\\",\\n          \\\"sub_category_id\\\": 5,\\n          \\\"description\\\": \\\"Historic Buddhist temple\\\",\\n          \\\"duration\\\": \\\"2-3 hours\\\",\\n          \\\"latitude\\\": 7.2910,\\n          \\\"longitude\\\": 80.6350,\\n          \\\"best_time\\\": \\\"morning\\\",\\n          \\\"cost_level\\\": \\\"low\\\"\\n        }\\n      ]\\n    }\\n  ]\\n}\\n\\nCRITICAL REMINDERS:\\n‚úì DO NOT include hotels/accommodation - ACTIVITIES ONLY\\n‚úì EVERY day MUST have pax object\\n‚úì EVERY activity MUST have latitude and longitude\\n‚úì EVERY activity MUST have sub_category_id (use category mapping)\\n‚úì Category mapping: Adventure=1, Entertainment=2, Health & Wellness=3, Event=4, Tours=5, Transport=6, Services=7, Tickets=8, Culinary=9, Experience=10, Vacation Packages=46\\n‚úì MAXIMUM 3 activities per day (no more than 3)\\n‚úì Mix different activity categories\\n‚úì Consider child ages when suggesting activities\\n‚úì Respect city schedule (${citiesRoute})\\n‚úì Last day can have fewer activities (departure day)\\n‚úì Respond with ONLY valid JSON, no markdown\\n\\nGenerate the ACTIVITIES-ONLY itinerary now!`;\n\n// Build the OpenAI API request body\nconst requestBody = {\n  model: \"gpt-4o\",\n  messages: [\n    {\n      role: \"system\",\n      content: \"You are an expert travel planner. Create detailed day-by-day activity itineraries with GPS coordinates and sub_category_id in JSON format only. EVERY activity MUST include sub_category_id based on category mapping: Adventure=1, Entertainment=2, Health & Wellness=3, Event=4, Tours=5, Transport=6, Services=7, Tickets=8, Culinary=9, Experience=10, Vacation Packages=46. DO NOT include hotels/accommodation.\"\n    },\n    {\n      role: \"user\",\n      content: userPrompt\n    }\n  ],\n  temperature: 0.7\n};\n\n// Return data with the request body and original input data\nreturn [{\n  json: {\n    ...inputData,\n    openai_request: requestBody\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -944,
        -176
      ],
      "id": "364f3a8b-f474-470d-bea6-94541a5a5918",
      "name": "Build Activities Itinerary Prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.openai_request) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -784,
        -176
      ],
      "id": "99376da9-6ded-4f4e-ad6f-c41237c1ae9d",
      "name": "OpenAI Itinerary Generator",
      "credentials": {
        "openAiApi": {
          "id": "CYHGS3KAjICCaQqY",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse OpenAI itinerary response and format for cart processing (ACTIVITIES ONLY)\nconst openAIResponse = $input.first().json.choices[0].message.content;\nconst inputData = $('Sanitize Data').first().json;\n\nlet itineraryData;\ntry {\n  // Remove markdown code blocks if present\n  let jsonString = openAIResponse.trim();\n  if (jsonString.startsWith('```json')) {\n    jsonString = jsonString.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n  } else if (jsonString.startsWith('```')) {\n    jsonString = jsonString.replace(/```\\n?/g, '');\n  }\n  \n  itineraryData = JSON.parse(jsonString);\n} catch (error) {\n  return [{\n    json: {\n      success: false,\n      message: \"Failed to parse OpenAI itinerary response\",\n      error: error.message,\n      raw_response: openAIResponse\n    }\n  }];\n}\n\n// Build itinerary with activities (no accommodation)\nconst itineraryWithActivities = itineraryData.itinerary.map(day => ({\n  day: day.day,\n  date: day.date,\n  city: day.city,\n  pax: day.pax,\n  activities: day.activities || []\n}));\n\n// Generate itinerary title\nconst travelData = inputData.travel_data;\nconst destination = travelData.destination?.[0] || 'Unknown';\nconst duration = travelData.duration || '';\nconst startDate = travelData.travel_dates?.start || '';\n\nconst cartReference = inputData.cart_reference;\nconst requestId = inputData.request_id;\n\n// Generate cart name\nconst cartNamePrefixes = [\n  'Adventure', 'Explorer', 'Wanderer', 'Voyager', 'Journey', 'Traveler',\n  'Discovery', 'Expedition', 'Paradise', 'Escape', 'Gateway', 'Odyssey'\n];\n\nconst cartNameSuffixes = [\n  'Experience', 'Journey', 'Adventure', 'Discovery', 'Quest', 'Expedition',\n  'Tour', 'Activities', 'Itinerary', 'Plan', 'Guide'\n];\n\nconst randomPrefix = cartNamePrefixes[Math.floor(Math.random() * cartNamePrefixes.length)];\nconst randomSuffix = cartNameSuffixes[Math.floor(Math.random() * cartNameSuffixes.length)];\nconst randomNumber = Math.floor(Math.random() * 999) + 1;\n\nconst cartName = `${randomPrefix} ${destination} ${randomSuffix} #${randomNumber}`;\nconst itineraryTitle = `${cartName} - ${duration} (${startDate})`;\n\n// Count total activities\nconst totalActivities = itineraryWithActivities.reduce((sum, day) => sum + (day.activities?.length || 0), 0);\n\n// Format response for Laravel API\nconst formattedResponse = {\n  success: true,\n  message: \"Day-wise activities itinerary generated successfully\",\n  itinerary_title: itineraryTitle,\n  cart_name: cartName,\n  cart_reference: cartReference,\n  request_id: requestId,\n  itinerary: itineraryWithActivities,\n  travel_data: inputData.travel_data,\n  user_id: inputData.user_id,\n  force_new_cart: true,\n  metadata: {\n    total_days: itineraryWithActivities.length,\n    total_activities: totalActivities,\n    generated_at: new Date().toISOString(),\n    generation_method: \"OpenAI GPT-4o\",\n    note: \"Activities only - no hotels included\",\n    cart_reference: cartReference,\n    cart_name: cartName,\n    request_id: requestId\n  }\n};\n\nreturn [{\n  json: formattedResponse\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -512,
        -176
      ],
      "id": "b88337e7-a9aa-490e-8131-385d20641853",
      "name": "Parse Activities Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.16.26.182:8000/api/automate/cart_process",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $item(\"0\").$node[\"HTTP Request\"].json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -768,
        -320
      ],
      "id": "b0ef5e3c-7b4d-42bd-9c23-59d76310bfd1",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "jsCode": "const cartTitle = $input.first().json.cart.cart_title;\n\nreturn [{\n  json: {\n    message: `\"${cartTitle}\" is created. Check your itinerary.`\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        -528
      ],
      "id": "621699a6-eae0-4803-ac15-965a6dae99c1",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://dev-gateway.aahaas.com/api/automate/cart_process",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -304,
        -176
      ],
      "id": "8b9dac63-051c-45b9-a021-76c95329de38",
      "name": "HTTP Request - Activities API"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Travel Content Processor Prompt\n\n‚ö†Ô∏è CRITICAL: Treat EACH request as INDEPENDENT. IGNORE any previous conversation history. Process ONLY the current customer input below.\n\nYou are a travel content processor. Your job is to take customer travel requests and convert them into a complete, detailed travel inquiry ready for processing. NEVER ask questions or request more information ‚Äî always make reasonable assumptions.\n\nYour Task\n\nTranslate any non-English content to English.\n\nExtract all provided information (destination, dates, travelers, preferences).\n\nFill in missing details using these DEFAULT assumptions:\n\nTravel Dates:\nIf the travel start date is not provided, assume the travel begins from 15 days after request_timestamp and today is 2025-11-08\nand determine the duration automatically based on the type of destination.\n\n\nCity tours ‚Üí 4‚Äì5 days\n\nCountry tours ‚Üí 7‚Äì10 days\n\nMulti-country tours ‚Üí 10‚Äì14 days\n\nNumber of Travelers: If not specified, assume 1 adult.\n\nBudget: If not mentioned, assume mid-range/standard budget.\n\nAccommodation: If not mentioned, assume 4-star hotels.\n\nMeal Plan: If not mentioned, assume Bed & Breakfast (BB).\n\nActivities: Assume popular tourist attractions and experiences for the destination.\n\n‚ö†Ô∏è CRITICAL Duration & Night Calculation Logic (MUST FOLLOW EXACTLY):\n\nüî¥ SIMPLE RULE - MEMORIZE THIS:\n\nWhen customer says \"X days\":\n\nDays Mentioned ‚Üí Nights to Use ‚Üí Cities to Use\n1 day        ‚Üí 1 night      ‚Üí 1 city\n2 days       ‚Üí 1 night      ‚Üí 1 city  \n3 days       ‚Üí 2 nights     ‚Üí 2 cities\n4 days       ‚Üí 3 nights     ‚Üí normal logic\n5 days       ‚Üí 4 nights     ‚Üí normal logic\n\nDO NOT calculate anything - just use the table above!\n\nExamples:\n- Customer says \"2 days\" ‚Üí You MUST write \"2 days, 1 night\" (NOT 2 nights)\n- Customer says \"3 days\" ‚Üí You MUST write \"3 days, 2 nights\" (NOT 3 nights)\n- Customer says \"5 days\" ‚Üí You write \"5 days, 4 nights\" (days - 1)\n\nOutput Format\n\nProvide only a clear, professional travel description in paragraph form.\nInclude:\n\nDestination(s)\n\nTravel dates (specific start and end dates)\n\nTotal days and nights (FOLLOW THE TABLE ABOVE EXACTLY)\n\nNumber of travelers\n\nAccommodation and meal plan\n\nBudget level\n\nKey activities or interests\n\nExample Output\n\n\"Customer requesting a Singapore city tour for 2 adults from November 15‚Äì19, 2025 (5 days, 4 nights). Mid-range budget with 4-star hotel accommodation and bed & breakfast meal plan. Interested in major attractions including Marina Bay Sands, Gardens by the Bay, Sentosa Island, and cultural spots such as Little India and Chinatown.\"\n\nCustomer Input:\n{{ $json.chatInput }}\n\n‚ö†Ô∏è REMEMBER: Process ONLY this current input. Ignore previous conversations. FOLLOW the days-to-nights table EXACTLY.\n\nProvide ONLY the refined travel description with all assumptions filled in. Do NOT ask questions.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -2048,
        -160
      ],
      "id": "7f905b52-58ce-4505-a080-f8a954c78312",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2048,
        128
      ],
      "id": "268caafd-5c7a-4725-b73d-d0aa88ce3f62",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "CYHGS3KAjICCaQqY",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1952,
        128
      ],
      "id": "f94619ea-ed19-409d-9456-90746a1b35e7",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "jsCode": "// Format AI Agent output for OpenAI Travel Parser\n// CRITICAL: This node ensures AI Agent output is properly formatted\n// The OpenAI Travel Parser will re-analyze this to ensure correct night calculations\nconst aiAgentOutput = $input.first().json.output || $input.first().json.text || '';\n\n// Clean the output - remove any potential formatting issues\nconst cleanedOutput = String(aiAgentOutput).trim();\n\nreturn [{\n  json: {\n    output: cleanedOutput,\n    emailContent: cleanedOutput\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1712,
        -160
      ],
      "id": "28d76fb3-1940-4757-ba39-ba4bdf861be4",
      "name": "Format for OpenAI Parser"
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "Merge Input Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook API Trigger": {
      "main": [
        [
          {
            "node": "Extract Webhook Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Webhook Data": {
      "main": [
        [
          {
            "node": "Merge Input Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Input Sources": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Format for OpenAI Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for OpenAI Parser": {
      "main": [
        [
          {
            "node": "OpenAI Travel Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Travel Parser": {
      "main": [
        [
          {
            "node": "Parse OpenAI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse OpenAI Response": {
      "main": [
        [
          {
            "node": "Process Cities & Hotel Rating",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Cities & Hotel Rating": {
      "main": [
        [
          {
            "node": "Add User ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add User ID": {
      "main": [
        [
          {
            "node": "Sanitize Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitize Data": {
      "main": [
        [
          {
            "node": "Build Itinerary Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Itinerary Prompt": {
      "main": [
        [
          {
            "node": "OpenAI Itinerary Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Itinerary Generator": {
      "main": [
        [
          {
            "node": "Parse Itinerary Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Itinerary Response": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "6b22fdbb-a5cc-4fbd-be76-df783b4d49a3",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9ba699815eee7a9b7506f6b264ee48edcb7b96a79c851198c7b7acafd2a5489c"
  },
  "id": "CSr8mIV9HzJ1826z",
  "tags": []
}